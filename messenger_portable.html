<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Messenger | Portable</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22g%22 x1=%220%22 y1=%220%22 x2=%221%22 y2=%221%22><stop offset=%220%22 stop-color=%22%230084ff%22/><stop offset=%221%22 stop-color=%22%23b300ff%22/></linearGradient></defs><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22url(%23g)%22/><path d=%22M30 40 L50 60 L70 40 M30 55 L50 75 L70 55%22 stroke=%22white%22 stroke-width=%228%22 fill=%22none%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/></svg>">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   P2P Messenger ‚Äî Premium Dark Theme v2.0
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* --- Imports --- */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

/* --- Design Tokens --- */
:root {
    /* Backgrounds */
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #1c2128;
    --bg-elevated: #21262d;
    --bg-surface: rgba(255, 255, 255, 0.04);

    /* Accent ‚Äî Blue-Indigo Gradient */
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --accent-glow: rgba(59, 130, 246, 0.25);
    --accent-gradient: linear-gradient(135deg, #3b82f6, #8b5cf6);
    --accent-gradient-hover: linear-gradient(135deg, #2563eb, #7c3aed);

    /* Text */
    --text: #e6edf3;
    --text-secondary: #8b949e;
    --text-dim: #484f58;

    /* Semantic */
    --success: #3fb950;
    --danger: #f85149;
    --warning: #d29922;

    /* Effects */
    --glass: rgba(255, 255, 255, 0.06);
    --glass-border: rgba(255, 255, 255, 0.08);
    --border: rgba(255, 255, 255, 0.06);
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
    --shadow-glow: 0 0 20px var(--accent-glow);

    /* Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    --radius-full: 50%;

    /* Transitions */
    --ease: cubic-bezier(0.4, 0, 0.2, 1);
    --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* --- Reset --- */
*,
*::before,
*::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Inter', 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* --- Scrollbars --- */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* --- Toast Notifications --- */
#toast {
    position: fixed;
    top: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(-120px);
    background: var(--bg-elevated);
    color: var(--text);
    padding: 12px 24px;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 500;
    z-index: 3000;
    box-shadow: var(--shadow-lg), inset 0 0 0 1px var(--glass-border);
    transition: 0.5s var(--ease-bounce);
    display: flex;
    align-items: center;
    gap: 10px;
    pointer-events: none;
    opacity: 0;
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
}

#toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Layout
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.app-container {
    display: flex;
    height: 100vh;
    width: 100vw;
    background: var(--bg-primary);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Sidebar
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.sidebar {
    width: 320px;
    background: var(--bg-secondary);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    border-right: 1px solid var(--border);
    position: relative;
    z-index: 10;
}

/* --- Profile Header --- */
.profile-header {
    padding: 20px;
    background: linear-gradient(180deg, rgba(59, 130, 246, 0.08) 0%, transparent 100%);
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    position: relative;
}

.profile-info h2 {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 3px;
    letter-spacing: -0.01em;
}

.profile-info small {
    font-size: 11px;
    color: var(--accent);
    opacity: 0.9;
    font-weight: 400;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: opacity 0.2s var(--ease);
}

.profile-info small:hover {
    opacity: 1;
}

.id-status-dot {
    width: 7px;
    height: 7px;
    border-radius: var(--radius-full);
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent-glow);
    animation: pulse-dot 2s infinite var(--ease);
}

@keyframes pulse-dot {

    0%,
    100% {
        opacity: 1;
        box-shadow: 0 0 8px var(--accent-glow);
    }

    50% {
        opacity: 0.6;
        box-shadow: 0 0 16px var(--accent-glow);
    }
}

/* --- Settings Button --- */
.btn-settings {
    margin-left: auto;
    cursor: pointer;
    opacity: 0.5;
    transition: all 0.25s var(--ease);
    font-size: 18px;
    padding: 6px;
    border-radius: var(--radius-sm);
}

.btn-settings:hover {
    opacity: 1;
    background: var(--bg-surface);
    transform: rotate(30deg);
}

/* --- Search Bar --- */
.search-container {
    padding: 12px 16px;
    display: flex;
    gap: 10px;
    align-items: center;
}

.search-container input {
    flex: 1;
    background: var(--bg-primary);
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    color: var(--text);
    font-size: 13px;
    font-family: inherit;
    outline: none;
    transition: all 0.3s var(--ease);
}

.search-container input::placeholder {
    color: var(--text-dim);
}

.search-container input:focus {
    background: var(--bg-tertiary);
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
}

/* --- Contact List --- */
.contact-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

/* JS-generated contact items */
.contact-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: var(--radius-md);
    cursor: pointer;
    margin-bottom: 2px;
    transition: all 0.2s var(--ease);
    position: relative;
    border: 1px solid transparent;
}

.contact-item:hover {
    background: var(--bg-surface);
    border-color: var(--glass-border);
}

.contact-item.active {
    background: rgba(59, 130, 246, 0.1);
    border-color: rgba(59, 130, 246, 0.2);
}

.contact-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 24px;
    background: var(--accent-gradient);
    border-radius: 0 3px 3px 0;
}

.contact-item .contact-info {
    flex: 1;
    min-width: 0;
}

.contact-item .contact-info .name {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
    gap: 6px;
}

.contact-item .contact-info .last-msg {
    font-size: 12px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 2px;
}

/* Legacy .contact class (HTML-defined) */
.contact {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: var(--radius-md);
    cursor: pointer;
    margin-bottom: 2px;
    transition: all 0.2s var(--ease);
    border: 1px solid transparent;
}

.contact:hover {
    background: var(--bg-surface);
    border-color: var(--glass-border);
}

.contact.active {
    background: rgba(59, 130, 246, 0.1);
    border-color: rgba(59, 130, 246, 0.2);
}

.contact-details {
    flex: 1;
    min-width: 0;
}

.contact-details div {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.contact-details span {
    font-size: 12px;
    color: var(--text-secondary);
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 2px;
}

/* --- Avatar --- */
.avatar {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-full);
    background: var(--bg-elevated);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 15px;
    flex-shrink: 0;
    box-shadow: var(--shadow-sm);
    position: relative;
}

/* --- Status Dot --- */
.status-dot {
    width: 10px;
    height: 10px;
    border-radius: var(--radius-full);
    background: var(--text-dim);
    border: 2px solid var(--bg-secondary);
    transition: background 0.3s var(--ease);
}

.status-dot.online {
    background: var(--success);
    box-shadow: 0 0 8px rgba(63, 185, 80, 0.4);
    animation: pulse-online 2s infinite var(--ease);
}

@keyframes pulse-online {

    0%,
    100% {
        box-shadow: 0 0 8px rgba(63, 185, 80, 0.4);
    }

    50% {
        box-shadow: 0 0 16px rgba(63, 185, 80, 0.6);
    }
}

/* --- Sidebar Bottom --- */
.sidebar>div:last-child .btn-main {
    background: var(--accent-gradient);
    border: none;
    font-weight: 600;
    letter-spacing: 0.01em;
    box-shadow: 0 4px 16px var(--accent-glow);
    transition: all 0.3s var(--ease);
}

.sidebar>div:last-child .btn-main:hover {
    box-shadow: 0 6px 24px var(--accent-glow);
    transform: translateY(-1px);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Chat Area
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
    overflow: hidden;
    position: relative;
}

/* --- Chat Header --- */
.chat-header {
    height: 56px;
    padding: 0 20px;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(12px);
    flex-shrink: 0;
}

.chat-header h3 {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: -0.01em;
}

.chat-header span,
.chat-header-info span {
    font-size: 12px;
    color: var(--text-secondary);
}

.chat-header-info {
    display: flex;
    flex-direction: column;
}

/* --- Messages Container --- */
.chat-main {
    flex: 1;
    display: flex;
    overflow: hidden;
    background: var(--bg-primary);
}

#messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* --- Message Bubbles (JS-generated) --- */
.message {
    max-width: 70%;
    padding: 10px 16px;
    border-radius: var(--radius-lg);
    font-size: 14px;
    line-height: 1.5;
    position: relative;
    animation: msg-in 0.3s var(--ease-bounce);
    word-break: break-word;
}

@keyframes msg-in {
    from {
        opacity: 0;
        transform: translateY(8px) scale(0.97);
    }

    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.message.them {
    align-self: flex-start;
    background: var(--bg-elevated);
    border: 1px solid var(--glass-border);
    border-bottom-left-radius: 4px;
    color: var(--text);
}

.message.me {
    align-self: flex-end;
    background: var(--accent-gradient);
    border-bottom-right-radius: 4px;
    color: #fff;
    box-shadow: 0 2px 12px var(--accent-glow);
}

.message .text {
    white-space: pre-wrap;
}

.message .time {
    font-size: 10px;
    opacity: 0.6;
    margin-top: 4px;
    text-align: right;
}

/* Legacy msg-group classes (from old template) */
.msg-group {
    display: flex;
    gap: 14px;
    max-width: 90%;
}

.msg-avatar {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
}

.msg-content {
    flex: 1;
}

.msg-header {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 4px;
}

.msg-nick {
    font-weight: 600;
    font-size: 15px;
}

.msg-time {
    font-size: 11px;
    color: var(--text-secondary);
}

.msg-text {
    font-size: 14px;
    line-height: 1.5;
    word-break: break-word;
    white-space: pre-wrap;
}

.msg-group.me .msg-text {
    opacity: 0.95;
}

.sys-msg {
    text-align: center;
    font-size: 13px;
    color: var(--text-dim);
    padding: 8px 16px;
    margin: auto;
}

/* --- Input Bar --- */
.input-bar {
    padding: 16px 20px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
    flex-shrink: 0;
}

.input-bar input {
    flex: 1;
    background: var(--bg-primary);
    border: 1px solid transparent;
    border-radius: var(--radius-xl);
    padding: 12px 18px;
    color: var(--text);
    font-size: 14px;
    font-family: inherit;
    outline: none;
    transition: all 0.3s var(--ease);
}

.input-bar input::placeholder {
    color: var(--text-dim);
}

.input-bar input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
    background: var(--bg-tertiary);
}

.btn-send {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    border-radius: var(--radius-full);
    background: var(--accent-gradient);
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.25s var(--ease);
    box-shadow: 0 2px 12px var(--accent-glow);
    position: static;
}

.btn-send:hover {
    transform: scale(1.08);
    box-shadow: 0 4px 20px var(--accent-glow);
}

.btn-send:active {
    transform: scale(0.95);
}

.btn-send:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* --- Fingerprint Badge --- */
.fingerprint {
    font-size: 11px;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    background: var(--bg-surface);
    border: 1px solid var(--glass-border);
    transition: all 0.2s var(--ease);
}

.fingerprint:hover {
    background: var(--bg-elevated);
    border-color: var(--accent);
    color: var(--accent);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Empty State
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.empty-state {
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
}

.empty-state .chat-header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
}

.empty-state h2 {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 8px;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.empty-state p {
    color: var(--text-secondary);
    font-size: 14px;
    max-width: 320px;
    line-height: 1.5;
}

.empty-state .btn-main {
    margin-top: 24px !important;
    background: var(--bg-elevated) !important;
    border: 1px solid var(--glass-border) !important;
    width: auto !important;
    padding: 10px 20px !important;
    font-size: 13px !important;
    border-radius: var(--radius-md) !important;
    transition: all 0.25s var(--ease) !important;
}

.empty-state .btn-main:hover {
    border-color: var(--accent) !important;
    background: rgba(59, 130, 246, 0.1) !important;
    color: var(--accent) !important;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Overlays & Modals
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.overlay,
.lock-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    backdrop-filter: blur(12px);
    animation: overlay-in 0.3s var(--ease);
}

.lock-screen {
    flex-direction: column;
    gap: 15px;
}

@keyframes overlay-in {
    from {
        opacity: 0;
    }

    to {
        opacity: 1;
    }
}

.modal {
    background: var(--bg-secondary);
    width: 90%;
    max-width: 440px;
    max-height: 85vh;
    border-radius: var(--radius-xl);
    padding: 28px;
    box-shadow: var(--shadow-lg), inset 0 0 0 1px var(--glass-border);
    border: 1px solid var(--border);
    overflow-y: auto;
    padding-bottom: 40px;
    animation: modal-in 0.35s var(--ease-bounce);
    position: relative;
}

@keyframes modal-in {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(10px);
    }

    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-bottom: 8px;
}

.modal h2 {
    font-size: 18px;
    font-weight: 600;
    letter-spacing: -0.01em;
}

.modal p {
    color: var(--text-secondary);
    font-size: 13px;
    line-height: 1.5;
}

/* --- Form Inputs --- */
.big-input {
    width: 100%;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    margin-bottom: 12px;
    color: var(--text);
    padding: 12px 16px;
    border-radius: var(--radius-md);
    outline: none;
    font-family: inherit;
    font-size: 14px;
    transition: all 0.3s var(--ease);
}

.big-input::placeholder {
    color: var(--text-dim);
}

.big-input:focus {
    border-color: var(--accent);
    background: var(--bg-tertiary);
    box-shadow: 0 0 0 3px var(--accent-glow);
}

/* --- Buttons --- */
.btn-main {
    width: 100%;
    background: var(--accent-gradient);
    color: #fff;
    border: none;
    padding: 12px 20px;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    font-family: inherit;
    transition: all 0.25s var(--ease);
    letter-spacing: 0.01em;
    box-shadow: 0 2px 8px var(--accent-glow);
}

.btn-main:hover {
    box-shadow: 0 4px 16px var(--accent-glow);
    transform: translateY(-1px);
}

.btn-main:active {
    transform: translateY(0) scale(0.98);
}

/* --- Color Picker --- */
.color-picker {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    padding: 8px;
    background: var(--bg-primary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
}

.color-dot {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-full);
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.25s var(--ease);
}

.color-dot:hover {
    transform: scale(1.15);
}

.color-dot.active {
    border-color: #fff;
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

/* --- Members Sidebar --- */
.members-sidebar {
    width: 240px;
    background: var(--bg-secondary);
    border-left: 1px solid var(--border);
    padding: 16px;
    overflow-y: auto;
}

.members-sidebar h4 {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
}

/* --- Back Button --- */
.btn-back {
    display: none;
    cursor: pointer;
    font-size: 18px;
    padding: 6px;
    border-radius: var(--radius-sm);
    transition: all 0.2s var(--ease);
}

.btn-back:hover {
    background: var(--bg-surface);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Mobile Responsive
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media screen and (max-width: 768px) {
    .sidebar {
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 100;
    }

    .chat-area {
        display: none;
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
    }

    .btn-back {
        display: flex;
    }

    .members-sidebar {
        width: 100%;
    }

    .message {
        max-width: 85%;
    }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Utility Animations
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@keyframes fade-in {
    from {
        opacity: 0;
    }

    to {
        opacity: 1;
    }
}

@keyframes slide-up {
    from {
        opacity: 0;
        transform: translateY(16px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes float {

    0%,
    100% {
        transform: translateY(0);
    }

    50% {
        transform: translateY(-6px);
    }
}

/* Selection */
::selection {
    background: rgba(59, 130, 246, 0.3);
    color: var(--text);
}
</style>
    <link rel="manifest" href="manifest.json?v=3.9">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body>

    <div id="toast">‚úÖ –ì–æ—Ç–æ–≤–æ!</div>
    <div id="sidebar-backdrop"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:900; backdrop-filter:blur(2px);"
        onclick="app.toggleSidebar()"></div>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –í—Ö–æ–¥ -->
    <div id="setup-overlay" class="overlay" style="display: none;">
        <div class="modal">
            <h1 id="setupTitle">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h1>
            <div class="setup-tabs" style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-main active" id="modeReg" onclick="app.setSetupMode('reg')"
                    style="height:35px; font-size:14px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <button class="btn-main" id="modeLogin" onclick="app.setSetupMode('login')"
                    style="height:35px; font-size:14px; background:#252525;">–í—Ö–æ–¥</button>
            </div>

            <p id="setupDesc">–í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è, —Ü–≤–µ—Ç –∏ –ø–∞—Ä–æ–ª—å</p>

            <div class="color-picker" id="setupColors">
                <div class="color-dot active" style="background: #ff4d4d;" data-color="#ff4d4d"></div>
                <div class="color-dot" style="background: #4dff4d;" data-color="#4dff4d"></div>
                <div class="color-dot" style="background: #0084ff;" data-color="#0084ff"></div>
                <div class="color-dot" style="background: #ffaa00;" data-color="#ffaa00"></div>
                <div class="color-dot" style="background: #b300ff;" data-color="#b300ff"></div>
            </div>

            <input type="text" id="setupName" class="big-input" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="20">
            <p style="font-size:10px; color:var(--danger); margin-top:-8px; margin-bottom:10px; opacity:0.8;">‚ö†Ô∏è
                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å–∫–ª–∞–¥–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã!</p>
            <input type="password" id="setupPass" class="big-input" placeholder="–ü–∞—Ä–æ–ª—å">

            <div id="login-2fa-choice" style="display:none; margin-top:15px;">
                <p style="font-size:12px; color:var(--text-dim); margin-bottom:10px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞:</p>
                <div style="display:flex; gap:10px;">
                    <button class="btn-main" style="flex:1; height:40px; font-size:13px;"
                        onclick="app.setLogin2fa('key')">üîë –ö–ª—é—á</button>
                    <button class="btn-main" style="flex:1; height:40px; font-size:13px; background:#0088cc;"
                        onclick="app.requestLoginTg()">‚úàÔ∏è Telegram</button>
                </div>
            </div>

            <input type="password" id="setupSecretInput" class="big-input" placeholder="–ö–ª—é—á –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
                style="display:none; margin-top:15px;">

            <div id="login-tg-wait"
                style="display:none; margin-top:15px; background:var(--glass); padding:10px; border-radius:10px;">
                <p style="font-size:12px; color:var(--text-dim);">–û—Ç–ø—Ä–∞–≤—å—Ç–µ <b>/login</b> –±–æ—Ç—É <a
                        href="https://t.me/p2p2fabot" target="_blank" style="color:var(--accent)">@p2p2fabot</a></p>
                <div id="loginTgStatus" style="font-size:11px; margin-top:5px; color:var(--accent);">–û–∂–∏–¥–∞–Ω–∏–µ
                    —Å–æ–æ–±—â–µ–Ω–∏—è...</div>
                <input type="text" id="setupTgCodeInput" class="big-input" placeholder="–ö–æ–¥ –∏–∑ Telegram" maxlength="6"
                    style="display:none; margin-top:10px;">
            </div>

            <div style="margin-top:20px; font-size:12px; color:var(--text-dim); text-align:center;">
                <a href="https://t.me/p2p2fabot" target="_blank" style="color:var(--accent); text-decoration:none;">üéß
                    –¢–µ—Ö. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </div>

            <div id="setup-secret-box"
                style="display:none; background:var(--glass); padding:10px; border-radius:8px; margin-top:10px; text-align:center;">
                <p style="font-size:12px; color:var(--text-dim); margin-bottom:5px;">üõ°Ô∏è –ö–ª—é—á –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–±–µ–∑ –Ω–µ–≥–æ –Ω–µ
                    –≤–æ–π—Ç–∏):</p>
                <button class="btn-main" style="height:35px; font-size:13px; background:var(--accent);"
                    onclick="navigator.clipboard.writeText(app.tempSecret || app.mySecret); app.showToast('–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! üÜî')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    –ö–ª—é—á</button>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button id="setupBtn" class="btn-main" style="flex:2" onclick="app.finishSetup()">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
                <button class="btn-main" style="flex:1; background:#252525;"
                    onclick="app.showSyncOverlay('target')">–°–∏–Ω—Ö—Ä–æ–Ω.</button>
                <button class="btn-main" style="flex:1; background:#252525;"
                    onclick="document.getElementById('importFile').click()">–ò–º–ø–æ—Ä—Ç</button>
            </div>
            <div id="setupError" style="color:var(--danger); font-size:12px; margin-top:10px; text-align:center;"></div>

            <div style="margin-top:25px; border-top:1px solid var(--border); padding-top:15px; text-align:center;">
                <p style="font-size:11px; color:var(--text-dim); margin-bottom:5px;">–í–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã?</p>
                <button class="btn-main"
                    style="background:transparent; color:var(--danger); border:1px solid var(--danger); height:30px; font-size:11px; width:auto; padding:0 15px;"
                    onclick="app.clearData()">‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
            </div>

            <div style="margin-top:30px; border-top:1px solid #333; padding-top:15px; width:100%; text-align:center;">
                <p style="font-size:11px; color:var(--text-dim); cursor:pointer; text-decoration:underline;"
                    onclick="app.clearData()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</p>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ IP / –ù–æ–≤–æ–µ –º–µ—Å—Ç–æ -->
    <div id="ip-overlay" class="lock-screen" style="display: none;">
        <div class="avatar"
            style="width:80px; height:80px; font-size:32px; margin-bottom:20px; background:var(--danger)">üõ°Ô∏è</div>
        <h2>–ù–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ?</h2>
        <p style="color:var(--text-dim); margin-bottom:30px; text-align:center; max-width:300px;">–ú—ã –∑–∞–º–µ—Ç–∏–ª–∏ –≤—Ö–æ–¥ —Å
            –Ω–æ–≤–æ–≥–æ IP –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à <b>–ö–ª—é—á –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</b>.</p>
        <div style="max-width:300px; width:90%;" id="ipFirstStep">
            <button class="btn-main" style="margin-bottom:12px;" onclick="app.show2faStep('key')">üîë –°–µ–∫—Ä–µ—Ç–Ω—ã–π
                –ö–ª—é—á</button>
            <button class="btn-main" style="background:#0088cc; margin-bottom:12px;" id="btnTgCodeReq"
                onclick="app.requestTg2fa()">‚úàÔ∏è –ö–æ–¥ –≤ Telegram</button>
            <div style="max-width:300px; width:90%; color:var(--text-dim); margin-top:30px; font-size:13px;">
                <p style="cursor:pointer; text-decoration:underline;" onclick="app.logout(true)">–ó–∞–±—ã–ª–∏ –∫–ª—é—á? –°–±—Ä–æ—Å–∏—Ç—å
                    –≤—Ö–æ–¥</p>
                <p style="margin-top:10px;">
                    <a href="https://t.me/p2p2fabot" target="_blank"
                        style="color:var(--accent); text-decoration:none;">üéß –°–≤—è–∑–∞—Ç—å—Å—è —Å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</a>
                </p>
            </div>
        </div>

        <div style="max-width:300px; width:90%; display:none;" id="ipKeyInputStep">
            <input type="password" id="ipSecretInput" class="big-input" placeholder="–í–∞—à —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á">
            <button class="btn-main" onclick="app.verifySecret()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button class="btn-main" style="background:transparent; font-size:12px; margin-top:10px;"
                onclick="app.show2faStep('choice')">‚Üê –ù–∞–∑–∞–¥</button>
            <div id="ipError" style="color:var(--danger); font-size:12px; margin-top:10px; text-align:center;"></div>
        </div>

        <div style="max-width:300px; width:90%; display:none;" id="ipTgInputStep">
            <p style="font-size:12px; color:var(--text-dim); margin-bottom:10px;">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram –±–æ—Ç—É.</p>
            <input type="text" id="ipTgCodeInput" class="big-input" placeholder="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥" maxlength="6">
            <button class="btn-main" onclick="app.verifyTg2fa()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ö–æ–¥</button>
            <button class="btn-main" style="background:transparent; font-size:12px; margin-top:10px;"
                onclick="app.show2faStep('choice')">‚Üê –ù–∞–∑–∞–¥</button>
            <div id="tgIpError" style="color:var(--danger); font-size:12px; margin-top:10px; text-align:center;"></div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ -->
    <div id="lock-overlay" class="lock-screen" style="display: none;">
        <div class="avatar" id="lockAvatar" style="width:80px; height:80px; font-size:32px;">?</div>
        <h2 id="lockNick">–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º</h2>
        <p style="color:var(--text-dim);">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞</p>
        <div style="max-width:300px; width:90%; display:flex; flex-direction:column; gap:10px;">
            <input type="password" id="lockPass" class="big-input" placeholder="–ü–∞—Ä–æ–ª—å"
                onkeypress="if(event.key==='Enter') app.unlock()">
            <button class="btn-main" onclick="app.unlock()">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="lockError" style="color:var(--danger); font-size:12px; text-align:center;"></div>
            <p style="font-size:11px; color:var(--text-dim); margin-top:20px; cursor:pointer; text-decoration:underline; text-align:center;"
                onclick="app.clearData()">–°–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∞–∫–∫–∞—É–Ω—Ç</p>
        </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div id="settings-overlay" class="overlay" style="display: none;"
        onclick="if(event.target===this) this.style.display='none'">
        <div class="modal">
            <div style="position:absolute; top:20px; right:20px; font-size:24px; cursor:pointer; color:var(--text-dim);"
                onclick="document.getElementById('settings-overlay').style.display='none'">‚úï</div>
            <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span
                    style="font-size:10px; color:var(--text-dim); vertical-align:middle; margin-left:10px; font-weight:normal;">v1.1</span>
            </h1>
            <p>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Ñ–∏–ª—å</p>
            <div id="encryptionStatus" style="font-size:11px; margin-bottom:15px; font-weight:600;"></div>
            <input type="text" id="editName" class="big-input" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">

            <div id="syncRegistrySection"
                style="margin: 20px 0; background:rgba(0,132,255,0.08); padding:15px; border-radius:15px; border:1px solid rgba(0,132,255,0.3); box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <h3 style="font-size:15px; margin:0 0 8px; color:#3fa9ff; display:flex; align-items:center; gap:8px;">
                    <span style="font-size:18px;">üîÑ</span> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (Auto-Sync)
                </h3>
                <p style="font-size:11px; color:var(--text-dim); margin-bottom:12px; line-height:1.4;">–≠—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ
                    —Å–≤—è–∑–∞–Ω–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞.</p>
                <button class="btn-main"
                    style="background:var(--accent); font-size:14px; height:40px; box-shadow: 0 4px 10px rgba(0,132,255,0.3);"
                    onclick="app.showSyncOverlay('source')">–°–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
            </div>

            <div style="margin: 15px 0; border-top: 1px solid var(--border); padding-top: 15px;">
                <p style="font-size:12px; color:var(--text-dim); margin-bottom:10px; text-align:left;">–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    –¥–∞–Ω–Ω—ã—Ö –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:</p>
                <input type="password" id="oldPass" class="big-input" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
            </div>

            <div style="margin: 15px 0;">
                <p style="font-size:12px; color:var(--text-dim); margin-bottom:10px; text-align:left;">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
                    (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç–µ):</p>
                <input type="password" id="editPass" class="big-input" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            </div>

            <div class="settings-section"
                style="text-align:left; margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">

                <h3 style="font-size:14px; margin-bottom:10px;">üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3>

                <label class="switch-item"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; cursor:pointer;">
                    <span style="font-size:13px;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ IP</span>
                    <input type="checkbox" id="settingIpCheck" onchange="app.toggleIpCheck(this.checked)">
                </label>

                <p id="keyWarning"
                    style="color:var(--danger); font-size:12px; margin:10px 0; font-weight:bold; display:none;">
                    üî¥ –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å–ª–∏ –≤—ã –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –ö–ª—é—á –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –¥–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω!
                </p>

                <button class="btn-main" style="background:var(--accent); margin-bottom:10px;"
                    onclick="navigator.clipboard.writeText(app.mySecret); app.showToast('–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! üÜî')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    –ö–ª—é—á</button>

                <h3 style="font-size:14px; margin:20px 0 10px;">ü§ñ Telegram 2FA (Direct API)</h3>
                <p style="font-size:11px; color:var(--text-dim); margin-bottom:10px;">
                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é @p2p2fabot) –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞.
                </p>
                <label class="switch-item"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; cursor:pointer;">
                    <span style="font-size:13px;">–í–∫–ª—é—á–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è</span>
                    <input type="checkbox" id="settingTgEnabled" onchange="app.toggleTg(this.checked)">
                </label>

                <div id="tgSettings"
                    style="display:none; background:var(--glass); padding:12px; border-radius:12px; margin-top:10px;">
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <input type="password" id="tgBotToken" placeholder="Bot Token (e.g. 8508148034:...)"
                            class="big-input" style="font-size:11px; margin-bottom:0;" onchange="app.saveTgSettings()">
                        <input type="text" id="tgChatId" placeholder="Your Chat ID (e.g. 12345678)" class="big-input"
                            style="font-size:11px; margin-bottom:0;" onchange="app.saveTgSettings()">
                        <div style="display:flex; gap:8px; margin-top:5px;">
                            <button class="btn-main" style="height:32px; font-size:11px; background:var(--accent);"
                                onclick="app.testTgConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å</button>
                            <button class="btn-main" style="height:32px; font-size:11px; background:#252525;"
                                onclick="window.open('https://t.me/userinfobot', '_blank')">–£–∑–Ω–∞—Ç—å –º–æ–π ID</button>
                        </div>
                        <p id="tgStatusLabel"
                            style="font-size:10px; color:var(--text-dim); margin-top:5px; text-align:center;">–ë–æ—Ç –Ω–µ
                            –Ω–∞—Å—Ç—Ä–æ–µ–Ω</p>
                    </div>
                </div>


                <h3 style="font-size:14px; margin:20px 0 10px;">‚ö° Fort Knox Mode</h3>
                <label class="switch-item"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; cursor:pointer;">
                    <span style="font-size:13px;">–†–µ–∂–∏–º –ò–Ω–∫–æ–≥–Ω–∏—Ç–æ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é)</span>
                    <input type="checkbox" id="settingIncognito" onchange="app.toggleIncognito(this.checked)">
                </label>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span style="font-size:13px;">–¢–∞–π–º–µ—Ä —É–¥–∞–ª–µ–Ω–∏—è (0 = –≤—ã–∫–ª)</span>
                    <select id="settingBurn" onchange="app.setBurnTimer(this.value)"
                        style="background:#1a1a1a; color:#fff; border:1px solid var(--border); border-radius:5px; padding:2px 5px;">
                        <option value="0">–í—ã–∫–ª</option>
                        <option value="10">10 —Å–µ–∫</option>
                        <option value="60">1 –º–∏–Ω</option>
                        <option value="300">5 –º–∏–Ω</option>
                        <option value="3600">1 —á–∞—Å</option>
                    </select>
                </div>

                <div id="p2pInstallContainer"
                    style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px; display:none;">
                    <h3 style="font-size:14px; margin-bottom:10px;">üì± –ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
                    <p style="font-size:11px; color:var(--text-dim); margin-bottom:10px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–∞
                        —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª –∏–ª–∏ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞.</p>
                    <button class="btn-main" style="background:var(--accent); font-size:13px; margin-bottom:10px;"
                        onclick="app.promptInstall()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Messenger</button>
                </div>

                <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                    <h3 style="font-size:14px; margin-bottom:10px;">üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h3>
                    <p style="font-size:11px; color:var(--text-dim); margin-bottom:10px;">–ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–æ–π—Ç–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                        PeerJS (–Ω—É–∂–µ–Ω —Å–≤–æ–π —Å–µ—Ä–≤–µ—Ä —Å–∏–≥–Ω–∞–ª–æ–≤).</p>

                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <input type="text" id="connHost" placeholder="Signaling Host (–Ω–∞–ø—Ä. peerjs.com)"
                            class="big-input" style="font-size:12px;">
                        <div style="display:flex; gap:8px;">
                            <input type="number" id="connPort" placeholder="Port" class="big-input"
                                style="font-size:12px; flex:1;">
                            <input type="text" id="connPath" placeholder="Path" class="big-input"
                                style="font-size:12px; flex:1;">
                        </div>
                        <label class="switch-item"
                            style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                            <span style="font-size:12px;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS</span>
                            <input type="checkbox" id="connSecure">
                        </label>

                        <p style="font-size:11px; color:var(--text-dim); margin-top:5px;">STUN/TURN –°–µ—Ä–≤–µ—Ä—ã (JSON):</p>
                        <textarea id="connIce"
                            style="background:#1a1a1a; color:#fff; border:1px solid var(--border); border-radius:10px; padding:10px; font-size:11px; font-family:monospace; height:80px;"></textarea>

                        <button class="btn-main" style="background:var(--accent); font-size:13px;"
                            onclick="app.applyConnectionSettings()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                    </div>
                </div>

                <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px; opacity:0.8;">
                    <h3 style="font-size:14px; margin-bottom:10px;">‚ùì –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–≤—è–∑—å—é?</h3>
                    <p style="font-size:11px; color:var(--text-dim); line-height:1.4;">
                        P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º. –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Cloudflare, –æ—Ç–∫–ª—é—á–∏—Ç–µ
                        <b>Rocket Loader</b> –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ <b>WebSockets</b> –≤–∫–ª—é—á–µ–Ω—ã. –í –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞—è—Ö –ø–æ–ø—Ä–æ–±—É–π—Ç–µ
                        —Å–º–µ–Ω–∏—Ç—å —Å–µ—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–∏ —Å–µ—Ä–≤–µ—Ä—ã —Å–∏–≥–Ω–∞–ª–æ–≤ –≤—ã—à–µ.
                    </p>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                <button class="btn-main" style="flex:1" onclick="app.updateProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn-main" style="flex:1; background:#252525;" onclick="app.exportData()">–≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn-main" style="flex:1; background:#252525;"
                    onclick="document.getElementById('importFile').click()">–ò–º–ø–æ—Ä—Ç</button>
            </div>
            <button class="btn-main" style="background:var(--bg-elevated); margin-top:10px; font-size:13px;"
                onclick="app.logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>

            <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                <p style="font-size:11px; color:var(--text-secondary); margin-bottom:8px; text-align:center;">–û–ø–∞—Å–Ω–∞—è
                    –∑–æ–Ω–∞</p>
                <button class="btn-main" style="background:var(--danger); font-size:13px;" onclick="app.clearData()">üóëÔ∏è
                    –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>
    </div>

    <!-- –î–µ—Ç–∞–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Safety Info) -->
    <div id="safety-overlay" class="overlay" style="display: none;"
        onclick="if(event.target===this) this.style.display='none'">
        <div class="modal" style="max-width: 400px;">
            <div style="position:absolute; top:20px; right:20px; font-size:24px; cursor:pointer; color:var(--text-dim);"
                onclick="document.getElementById('safety-overlay').style.display='none'">‚úï</div>
            <h2 id="safetyTitle">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —á–∞—Ç–∞</h2>
            <div id="safetyBadges" style="margin:15px 0;"></div>

            <div style="background:var(--glass); padding:15px; border-radius:15px; margin-bottom:20px;">
                <p style="font-size:12px; margin-bottom:10px; color:var(--text-dim);">–ö–æ–¥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Fingerprint):
                </p>
                <div id="safetyFingerprintDisplay" style="font-size:32px; letter-spacing:8px; margin-bottom:5px;"></div>
                <p style="font-size:11px; color:var(--text-dim);">–ï—Å–ª–∏ —ç—Ç–æ—Ç –∫–æ–¥ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –Ω–∞ –æ–±–æ–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –ø–µ—Ä–µ—Ö–≤–∞—Ç
                    —Å–æ–æ–±—â–µ–Ω–∏–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.</p>
            </div>

            <div style="text-align:left; font-size:12px; line-height:1.6; color:var(--text-dim); margin-bottom:20px;">
                <p>üîí <b>–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è:</b> ECDH P-256 (Handshake) + AES-GCM 256 (Payload)</p>
                <p>üõ°Ô∏è <b>Peer-to-Peer:</b> –ü—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤.</p>
            </div>

            <div id="safetyVerifyContainer">
                <button id="btnVerify" class="btn-main" onclick="app.verifyContact()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å ‚úÖ</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="profile-header">
                <div class="profile-info">
                    <h2 id="myNickDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <small id="myIdDisplay" onclick="app.copyMyId()" style="cursor:pointer; opacity:0.7;">
                        ID: ... <span class="id-status-dot"></span>
                    </small>
                </div>
                <!-- Settings -->
                <div class="btn-settings" onclick="app.openSettings()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</div>
            </div>

            <div class="search-container" style="display:flex; gap:10px; align-items:center;">
                <!-- Dummy field to trick Chrome's autofill -->
                <input type="text" style="display:none;" tabindex="-1">
                <input type="password" style="display:none;" tabindex="-1">

                <input type="text" id="contactSearch" placeholder="–ü–æ–∏—Å–∫ –∏–ª–∏ –≤–≤–æ–¥ ID..."
                    onkeypress="if(event.key==='Enter') app.tryAddFriend()" style="flex:1" autocomplete="new-password"
                    spellcheck="false" oninput="app.refreshContacts()" name="p2p_search_v3" readonly
                    onfocus="this.removeAttribute('readonly')">
                <div class="btn-settings" onclick="app.shareInvite()" title="–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞"
                    style="margin:0; font-size:18px; color:var(--text-dim);">üîó</div>
                <div class="btn-settings" onclick="document.getElementById('group-create-overlay').style.display='flex'"
                    title="–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É" style="margin:0; font-size:18px; color:var(--text-dim);">üë•</div>
            </div>

            <div class="contact-list" id="contactList">
                <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
            </div>

        </div>

        <div class="chat-area" id="chatArea" style="display: none;">
            <div class="chat-header">
                <div class="btn-back" onclick="app.toggleSidebar()">‚¨ÖÔ∏è</div>
                <div class="avatar" style="width:36px; height:36px; font-size:14px;" id="chatAvatar">?</div>
                <div class="chat-header-info">
                    <h3 id="chatName"></h3>
                    <span id="chatStatus"></span>
                </div>
                <div id="chatSafety" class="fingerprint" style="margin-left:auto; display:none;"
                    onclick="app.showSafetyInfo()">
                    <span id="fingerprintValue"></span>
                </div>
                <div id="membersToggle" class="btn-settings" style="display:none; font-size:18px;"
                    onclick="app.toggleMembersList()" title="–£—á–∞—Å—Ç–Ω–∏–∫–∏">üë•</div>
            </div>

            <div class="chat-main">
                <div id="messages">
                    <div class="sys-msg" style="margin-top:auto;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –≤—ã–±—Ä–∞–≤ –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –¥–æ–±–∞–≤–∏–≤ –ø–æ ID
                    </div>
                </div>

                <div class="members-sidebar" id="membersSidebar" style="display:none;">
                    <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h4>
                    <div id="membersList"></div>
                </div>
            </div>

            <div class="input-bar">
                <input type="text" id="msgInput" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                    onkeypress="if(event.key==='Enter') app.sendMessage()" disabled>
                <button id="sendBtn" class="btn-send" onclick="app.sendMessage()" disabled>‚û§</button>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyChat" class="chat-area empty-state">
            <div class="chat-header">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
            </div>
            <div
                style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:16px; padding-bottom:60px;">
                <div style="font-size: 48px; animation: float 3s ease-in-out infinite;">üí¨</div>
                <h2 style="font-size:20px; font-weight:600; color:#e6edf3;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</h2>
                <p style="font-size:13px; color:#8b949e; text-align:center; max-width:280px; line-height:1.5;">–í—ã–±–µ—Ä–∏—Ç–µ
                    –∫–æ–Ω—Ç–∞–∫—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–≥–∞ –ø–æ —Å—Å—ã–ª–∫–µ</p>
            </div>

            <!-- Fake Input Bar for Empty State visual match -->
            <div class="input-bar" style="opacity:0.5; pointer-events:none;">
                <input type="text" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                <button class="btn-send" disabled>‚û§</button>
            </div>
        </div>
    </div>

    <!-- –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã -->
    <div id="group-create-overlay" class="overlay" style="display: none;"
        onclick="if(event.target===this) this.style.display='none'">
        <div class="modal" style="max-width: 400px;">
            <div style="position:absolute; top:20px; right:20px; font-size:24px; cursor:pointer; color:var(--text-dim);"
                onclick="document.getElementById('group-create-overlay').style.display='none'">‚úï</div>
            <h2>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
            <p style="font-size:12px; color:var(--text-dim); margin-bottom:15px;">–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ
                –¥–æ–±–∞–≤–∏—Ç—å
                —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ –∏—Ö ID.</p>
            <input type="text" id="groupNameInput" class="big-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" maxlength="30">
            <button class="btn-main" style="margin-top:10px;"
                onclick="app.createGroup(document.getElementById('groupNameInput').value)">–°–æ–∑–¥–∞—Ç—å üöÄ</button>
        </div>
    </div>

    <!-- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (Sync Overlay) -->
    <div id="sync-overlay" class="overlay" style="display: none;">
        <div class="modal" style="max-width: 400px; text-align:center;">
            <div style="position:absolute; top:20px; right:20px; font-size:24px; cursor:pointer;"
                onclick="document.getElementById('sync-overlay').style.display='none'">‚úï</div>
            <h2>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h2>

            <!-- Source View -->
            <div id="syncSourceView" style="display:none;">
                <p style="font-size:13px; color:var(--text-dim); margin-bottom:15px;">–í–≤–µ–¥–∏—Ç–µ <b>Source ID</b> –Ω–∞ –¥—Ä—É–≥–æ–º
                    —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:</p>
                <div id="syncCodeDisplay"
                    style="font-family: 'Courier New', Courier, monospace; font-size:15px; font-weight:bold; color:var(--accent); background:rgba(0,132,255,0.1); padding:15px; border-radius:10px; border:1px solid rgba(0,132,255,0.2); margin-bottom:20px; word-break:break-all; line-height:1.4;">
                    ------</div>
                <div id="syncSourceStatus" style="font-size:11px; color:var(--text-dim);">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>
            </div>

            <!-- Target View -->
            <div id="syncTargetView" style="display:none;">
                <p style="font-size:13px; color:var(--text-dim); margin-bottom:15px;">–í—Å—Ç–∞–≤—å—Ç–µ <b>Source ID</b> —Å
                    –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</p>
                <input type="text" id="syncInputCode" class="big-input" placeholder="p2p_user_..."
                    style="text-align:center; font-size:14px; font-family: monospace;">
                <button class="btn-main" style="margin-top:15px;" onclick="app.startSyncPull()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∏
                    –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏</button>
                <div id="syncTargetStatus" style="font-size:11px; color:var(--text-dim); margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <!-- Core & Modules -->
    <script>
class App {
    constructor() {
        this.peer = null;
        this.tempPeer = null; // For pre-login sync
        this.connections = {};
        this.myId = '';

        // Persistent Device Suffix for stable Peer IDs
        let savedSuffix = localStorage.getItem('p2p_device_suffix');
        if (!savedSuffix) {
            savedSuffix = Math.random().toString(36).substr(2, 4);
            localStorage.setItem('p2p_device_suffix', savedSuffix);
        }
        this.deviceSuffix = savedSuffix;

        // Data Store
        this.contacts = {};
        this.groups = {};
        this.history = {};
        this.myDevices = []; // List of trusted device IDs

        // Security
        this.myNick = '';
        this.myColor = '#0084ff';
        this.myPass = ''; // Hashed password
        this.mySecret = ''; // 2FA Secret
        this.is2faEnabled = false;
        this.is2faEnabled = false;
        this.incognitoMode = localStorage.getItem('p2p_incognito') === 'true';
        this.burnTimer = parseInt(localStorage.getItem('p2p_burn_timer') || '0');
        this.notificationsEnabled = localStorage.getItem('p2p_notifications') === 'true';
        this.ipCheckEnabled = localStorage.getItem('p2p_ip_check') === 'true';

        // Connectivity Override
        this.connSettings = {
            host: localStorage.getItem('p2p_conn_host') || '',
            port: localStorage.getItem('p2p_conn_port') || '',
            path: localStorage.getItem('p2p_conn_path') || '/',
            secure: localStorage.getItem('p2p_conn_secure') !== 'false', // default true
            ice: localStorage.getItem('p2p_conn_ice') || ''
        };

        // E2EE
        this.identityKeyPair = null;
        this.sessionSecrets = {}; // peerId -> CryptoKey

        // UI State
        this.activeChatId = null;
    }

    async init() {
        // Load settings
        const savedNick = localStorage.getItem('p2p_nick');
        const savedUid = localStorage.getItem('p2p_uid');
        const savedColor = localStorage.getItem('p2p_color');
        const savedPass = localStorage.getItem('p2p_pass');
        const savedSecret = localStorage.getItem('p2p_secret');
        const savedDevices = localStorage.getItem('p2p_my_devices');

        if (savedDevices) this.myDevices = JSON.parse(savedDevices);

        // Load Encrypted Data
        // Now loaded from crypto.js (prototype extension)
        if (this.loadEncryptedData) {
            await this.loadEncryptedData();
        } else {
            console.error("Critical: loadEncryptedData not found!");
        }

        if (savedNick && savedUid && savedPass) {
            this.myNick = savedNick;
            this.myId = savedUid;
            this.myColor = savedColor || '#0084ff';
            this.myPass = savedPass;
            this.mySecret = savedSecret || '';

            if (localStorage.getItem('p2p_is_locked') === 'true') {
                document.getElementById('lock-overlay').style.display = 'flex';
                this.updateMyProfileUI();
            } else {
                this.start();
                this.checkIP();
            }
        } else {
            // New user setup
            document.getElementById('setup-overlay').style.display = 'flex';
        }

        // Initialize Telegram Bot if enabled
        this.initTgBot();

        // Global Event Listeners (UI)
        document.getElementById('msgInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.sendMessage();
        });

        // Prevent accidental back navigation on mobile
        history.pushState(null, null, location.href);
        window.onpopstate = () => {
            if (this.activeChatId) {
                document.getElementById('chatArea').style.display = 'none';
                // On mobile "Back", we show sidebar (which is default visible on desktop)
                // But if we are in "mobile view", sidebar is hidden when chat is open.
                // toggleSidebar() handles showing sidebar.
                // But here we want to reset state.
                const sidebar = document.getElementById('sidebar');
                if (window.innerWidth <= 768) {
                    sidebar.style.display = 'flex';
                }
                const empty = document.getElementById('emptyChat');
                if (empty) empty.style.display = 'flex'; // Show empty state

                this.activeChatId = null;
                history.pushState(null, null, location.href);
            }
        };
    }

    start() {
        this.updateMyProfileUI();

        // Use a unique connection ID (Base ID + Suffix) to allow multiple devices for same user
        const connectionId = `${this.myId}_dev_${this.deviceSuffix}`;
        console.log('Connecting with ID:', connectionId);

        const peerOptions = {
            debug: 1
        };

        // Apply custom signaling if host is set
        if (this.connSettings.host) {
            peerOptions.host = this.connSettings.host;
            if (this.connSettings.port) peerOptions.port = parseInt(this.connSettings.port);
            if (this.connSettings.path) peerOptions.path = this.connSettings.path;
            peerOptions.secure = this.connSettings.secure;
        }

        // Apply custom ICE or defaults
        let iceServers = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
            { urls: 'stun:stun.l.google.com:19305' },
            { urls: 'stun:stun.voipstunt.com' },
            { urls: 'stun:stun.ekiga.net' }
        ];

        if (this.connSettings.ice) {
            try {
                const customIce = JSON.parse(this.connSettings.ice);
                if (Array.isArray(customIce)) iceServers = customIce;
            } catch (e) {
                console.error("Invalid custom ICE config:", e);
            }
        }

        peerOptions.config = {
            iceServers: iceServers,
            iceCandidatePoolSize: 10
        };

        this.peer = new Peer(connectionId, peerOptions);

        this.peer.on('error', (err) => {
            console.error('PeerJS Error:', err);
            if (err.type === 'network') {
                this.showToast("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
            } else if (err.type === 'peer-unavailable') {
                // Don't toast for bg reconnects, only for active attempts?
            }
        });

        this.peer.on('open', (id) => {
            console.log('Peer ID:', id);
            this.updateMyProfileUI(); // Show online status
            this.checkHash();
            this.reconnect();
            this.discoverMyDevices();
        });

        this.peer.on('connection', (conn) => this.handleConnection(conn));

        this.peer.on('error', (err) => {
            console.error("Peer Error:", err.type, err);
            const status = document.getElementById('chatStatus');
            const myIdDisplay = document.getElementById('myIdDisplay');

            if (err.type === 'unavailable-id') {
                this.showToast('–û—à–∏–±–∫–∞: –≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ‚ö†Ô∏è');
                if (status) status.innerText = "–ö–æ–Ω—Ñ–ª–∏–∫—Ç: ID —É–∂–µ –≤ —Å–µ—Ç–∏";
                if (myIdDisplay) myIdDisplay.innerText = "–û—à–∏–±–∫–∞: ID –∑–∞–Ω—è—Ç";
            } else if (err.type === 'peer-unavailable') {
                if (status && this.activeChatId) status.innerText = "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ñ—Ñ–ª–∞–π–Ω (–ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID)";
            } else if (err.type === 'network') {
                if (status) status.innerHTML = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ <span style='cursor:pointer; text-decoration:underline;' onclick='app.reconnect()'>üîÑ –ü–æ–≤—Ç–æ—Ä</span>";
                if (myIdDisplay) myIdDisplay.innerHTML = `${this.myId} <br> <span style="color:var(--danger)">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ üì∂</span>`;
            }
            this.updateMyProfileUI();
        });

        this.peer.on('disconnected', () => {
            this.updateMyProfileUI();
            setTimeout(() => { if (this.peer.disconnected) this.peer.reconnect(); }, 5000);
        });

        this.refreshContacts();
    }

    // Core Connection Handler
    handleConnection(conn) {
        conn.on('open', () => {
            this.connections[conn.peer] = conn;
            if (this.contacts[conn.peer]) {
                this.updateChatHeader();
                this.refreshContacts(); // update online status dot
            }

            // Send my profile info eagerly
            conn.send({
                type: 'profile',
                info: {
                    name: this.myNick,
                    color: this.myColor
                }
            });

            // Initiate E2EE Handshake
            this.initiateHandshake(conn.peer);
        });

        conn.on('data', async (data) => {
            if (data.type === 'profile') {
                // Update Contact Info
                if (data.info) {
                    if (!this.contacts[conn.peer]) {
                        this.contacts[conn.peer] = {
                            id: conn.peer,
                            name: data.info.name || conn.peer,
                            color: data.info.color || this.getRandomColor(),
                            added: Date.now(),
                            last: ''
                        };
                        this.showToast(`–ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç: ${data.info.name || conn.peer}`);
                    } else {
                        this.contacts[conn.peer].name = data.info.name || this.contacts[conn.peer].name;
                        this.contacts[conn.peer].color = data.info.color || this.contacts[conn.peer].color;
                    }
                    this.saveContacts();
                    this.refreshContacts();
                    if (this.activeChatId === conn.peer) this.updateChatHeader();
                }
            } else if (data.type === 'handshake') {
                await this.handleHandshake(conn.peer, data.publicKey);
            } else if (data.type === 'msg') {
                // Decrypt if needed
                let text = data.text;
                if (data.encrypted) {
                    text = await this.decryptSessionMsg(conn.peer, data.payload, data.iv);
                }

                // Double check they are in contacts so they show in sidebar
                if (!this.contacts[conn.peer] && !this.groups[conn.peer]) {
                    this.contacts[conn.peer] = {
                        id: conn.peer,
                        name: conn.peer,
                        color: this.getRandomColor(),
                        added: Date.now(),
                        last: ''
                    };
                    this.saveContacts(true);
                    this.refreshContacts();
                }

                this.saveMsg(conn.peer, text, 'them', data.senderId);

                // Auto-Relay to my other devices if it's a message for ME or from a group
                if (!data.isRelay) {
                    this.relayToMyDevices({
                        ...data,
                        isRelay: true
                    });
                }
            } else if (data.type === 'auto_sync') {
                this.processSyncData(data);
            } else if (data.type === 'sync_pull') {
                this.handleSyncPush(conn);
            } else if (data.type === 'sync_push') {
                this.processSyncData(data.payload);
            }
        });

        conn.on('close', () => {
            // Cleanup if needed
        });
    }

    async saveMsg(id, text, side, senderId = null, silent = false) {
        if (!this.history[id]) this.history[id] = [];

        const msgObj = {
            text: text,
            side: side,
            senderId: senderId,
            timestamp: Date.now()
        };

        this.history[id].push(msgObj);

        // Save Encrypted (only if NOT Incognito)
        if (!this.incognitoMode) {
            await this.saveMsgMigration(silent);
        }

        if (this.activeChatId === id) {
            this.renderHistory(id);
            // Scroll to bottom
            const container = document.getElementById('messages');
            if (container) container.scrollTop = container.scrollHeight;
        } else if (side === 'them' && !silent) {
            this.showToast(`–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${this.contacts[id] ? this.contacts[id].name : id}`);
            this.sendNotification(this.contacts[id] ? this.contacts[id].name : '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', text);
        }

        if (this.contacts[id]) {
            this.contacts[id].last = (side === 'me' ? '–í—ã: ' : '') + text;
            if (!this.incognitoMode) this.saveContacts(silent);
            this.refreshContacts();
        } else if (this.groups[id]) {
            this.groups[id].last = text;
            if (!this.incognitoMode) this.saveGroups(silent);
            this.refreshContacts();
        }

        // Burn Timer Logic
        if (this.burnTimer > 0) {
            setTimeout(() => {
                // Remove from memory
                if (this.history[id]) {
                    const idx = this.history[id].indexOf(msgObj);
                    if (idx > -1) {
                        this.history[id].splice(idx, 1);
                        // Update UI if active
                        if (this.activeChatId === id) this.renderHistory(id);
                        // Save changes (if not incognito) to remove from disk
                        if (!this.incognitoMode) this.saveMsgMigration(true);
                    }
                }
            }, this.burnTimer * 1000);
        }
    }

    sendNotification(title, body) {
        if (!this.notificationsEnabled) return;
        if (Notification.permission === 'granted') {
            new Notification(title, { body: body, icon: 'icon.png' });
        }
    }

    // Kept core sending logic here for now
    async sendMessage() {
        const text = document.getElementById('msgInput').value.trim();
        if (!text || !this.activeChatId) return;

        document.getElementById('msgInput').value = '';
        this.saveMsg(this.activeChatId, text, 'me');

        // Check if Group
        if (this.groups[this.activeChatId]) {
            this.groups[this.activeChatId].members.forEach(async memberId => {
                if (memberId === this.myId) return;
                // ... (group send logic placeholder - needs robust handling from sync.js/connections)
            });
        } else {
            // Direct Message
            const conn = this.connections[this.activeChatId];
            if (conn && conn.open) {
                const encrypted = await this.encryptSessionMsg(this.activeChatId, text);
                if (encrypted) {
                    conn.send({ type: 'msg', text: 'üîí Encrypted', encrypted: true, payload: encrypted.payload, iv: encrypted.iv });
                } else {
                    conn.send({ type: 'msg', text: text });
                }
            }
        }
    }

    reconnect() {
        if (this.peer && this.peer.disconnected) {
            this.peer.reconnect();
        } else if (!this.peer || this.peer.destroyed) {
            this.start();
        }

        Object.keys(this.contacts).forEach(id => {
            if (!this.connections[id] || !this.connections[id].open) {
                const conn = this.peer.connect(id, { serialization: 'json' });
                this.handleConnection(conn);
            }
        });
    }

    // Placeholders for modular methods to prevent errors if loaded out of order
    // But since index.html loads them after app.js, the prototype extensions will happen
    // BEFORE window.app = new App() is called (if we structured it right).
    // Actually, App class is defined here. Extensions run. THEN instance created.
}

</script>
    <script>
// Utility Functions
Object.assign(App.prototype, {
    showToast(msg) {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.className = "show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    },

    formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    },

    escapeHtml(text) {
        if (!text) return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    },

    normalizeId(id) {
        if (!id) return '';
        const prefix = id.startsWith('u_') ? 'u_' : 'p2p_user_';
        const clean = id.replace('p2p_user_', '').replace('u_', '').toLowerCase().replace(/[^a-z0-9\_]/g, '');
        return prefix + clean;
    },

    // Debug logging for sync
    logSync(msg) {
        console.log('[SyncDebug]', msg);
        const statusEl = document.getElementById('syncTargetStatus');
        if (statusEl) statusEl.innerText = msg;
    },

    // Helper to request full screen (optional)
    toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen();
        }
    },

    getRandomColor() {
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#D4A5A5', '#9B59B6', '#3498DB'];
        return colors[Math.floor(Math.random() * colors.length)];
    }
});

</script>
    <script>
// Cryptographic Functions (Restored)
Object.assign(App.prototype, {
    // 1. Generate ECDH Key Pair (for session security)
    async generateKeyPair() {
        return window.crypto.subtle.generateKey(
            { name: "ECDH", namedCurve: "P-256" },
            true,
            ["deriveKey", "deriveBits"]
        );
    },

    // 2. Export Public Key (to send to peer)
    async exportPublicKey() {
        // If no identity key, generate one (lazy init)
        if (!this.identityKeyPair) {
            // Check if stored
            const storedPriv = localStorage.getItem('p2p_priv_key');
            const storedPub = localStorage.getItem('p2p_pub_key');
            if (storedPriv && storedPub) {
                const privKey = await window.crypto.subtle.importKey(
                    "jwk", JSON.parse(storedPriv),
                    { name: "ECDH", namedCurve: "P-256" },
                    true, ["deriveKey", "deriveBits"]
                );
                const pubKey = await window.crypto.subtle.importKey(
                    "jwk", JSON.parse(storedPub),
                    { name: "ECDH", namedCurve: "P-256" },
                    true, []
                );
                this.identityKeyPair = { privateKey: privKey, publicKey: pubKey };
            } else {
                await this.generateIdentityKey(); // Defined in auth.js logic but needed here?
                // Wait, generateIdentityKey sets this.identityKeyPair.
            }
        }

        if (!this.identityKeyPair) return null;

        const exported = await window.crypto.subtle.exportKey("jwk", this.identityKeyPair.publicKey);
        return exported;
    },

    // 3. Import Peer's Public Key
    async importPublicKey(jwk) {
        return window.crypto.subtle.importKey(
            "jwk", jwk,
            { name: "ECDH", namedCurve: "P-256" },
            true,
            []
        );
    },

    // 4. Derive Shared Secret (ECDH)
    async deriveSharedSecret(peerPublicKey) {
        if (!this.identityKeyPair || !this.identityKeyPair.privateKey) return null;

        return window.crypto.subtle.deriveKey(
            { name: "ECDH", public: peerPublicKey },
            this.identityKeyPair.privateKey,
            { name: "AES-GCM", length: 256 },
            true,
            ["encrypt", "decrypt"]
        );
    },

    // 5. Encrypt Message
    async encryptSessionMsg(peerId, text) {
        const secret = this.sessionSecrets[peerId];
        if (!secret) return null;

        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const encoded = new TextEncoder().encode(text);

        const encrypted = await window.crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            secret,
            encoded
        );

        return {
            payload: Array.from(new Uint8Array(encrypted)), // Convert to array for JSON serialization
            iv: Array.from(iv)
        };
    },

    // 6. Decrypt Message
    async decryptSessionMsg(peerId, encryptedData, iv) {
        const secret = this.sessionSecrets[peerId];
        if (!secret) return "[–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏: –Ω–µ—Ç –∫–ª—é—á–∞]";

        try {
            // Convert back to Uint8Array
            const dataArray = new Uint8Array(encryptedData);
            const ivArray = new Uint8Array(iv);

            const decrypted = await window.crypto.subtle.decrypt(
                { name: "AES-GCM", iv: ivArray },
                secret,
                dataArray
            );
            return new TextDecoder().decode(decrypted);
        } catch (e) {
            console.error("Decryption failed:", e);
            return "[–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏]";
        }
    },

    // 7. Handshake Orchestration
    async initiateHandshake(peerId) {
        const conn = this.connections[peerId];
        if (!conn || !conn.open) return;

        console.log('[E2EE] Initiating handshake with:', peerId);
        const myPubKey = await this.exportPublicKey();
        if (myPubKey) {
            conn.send({ type: 'handshake', publicKey: myPubKey });
        }
    },

    async handleHandshake(peerId, peerPubKeyJwk) {
        console.log('[E2EE] Handling handshake from:', peerId);
        try {
            const peerPubKey = await this.importPublicKey(peerPubKeyJwk);
            const sharedSecret = await this.deriveSharedSecret(peerPubKey);

            if (sharedSecret) {
                this.sessionSecrets[peerId] = sharedSecret;
                console.log('[E2EE] Session established with:', peerId);

                // Persist this session key
                await this.saveSessionSecret(peerId, sharedSecret);

                this.updateChatHeader(); // Update UI to show üîí
            }
        } catch (e) {
            console.error('[E2EE] Handshake failed:', e);
        }
    },

    async saveSessionSecret(peerId, cryptoKey) {
        try {
            const exported = await window.crypto.subtle.exportKey("jwk", cryptoKey);
            const stored = localStorage.getItem('p2p_session_keys');
            const keys = stored ? JSON.parse(stored) : {};
            keys[peerId] = exported;
            localStorage.setItem('p2p_session_keys', JSON.stringify(keys));
        } catch (e) {
            console.error("Failed to save session secret:", e);
        }
    },

    async loadSessionSecrets() {
        const stored = localStorage.getItem('p2p_session_keys');
        if (!stored) return;
        try {
            const keys = JSON.parse(stored);
            for (const peerId in keys) {
                try {
                    const imported = await window.crypto.subtle.importKey(
                        "jwk", keys[peerId],
                        { name: "AES-GCM", length: 256 },
                        true, ["encrypt", "decrypt"]
                    );
                    this.sessionSecrets[peerId] = imported;
                } catch (e) {
                    console.error(`Failed to import session key for ${peerId}:`, e);
                }
            }
        } catch (e) {
            console.error("Failed to load session secrets:", e);
        }
    },

    // Internal Encryption for Local Data (using password)
    async encrypt(data) {
        try {
            const str = JSON.stringify(data);
            return btoa(unescape(encodeURIComponent(str)));
        } catch (e) {
            console.error("Encryption (Base64) failed:", e);
            return null;
        }
    },

    async decrypt(str) {
        if (!str || str === "null") return null;
        try {
            return JSON.parse(decodeURIComponent(escape(atob(str))));
        } catch (e) {
            console.error("Decryption (Base64) failed:", e);
            return null;
        }
    },

    // Security Migration for older keys
    async saveMsgMigration(silent = false) {
        const encryptedHistory = await this.encrypt(this.history);
        const encryptedContacts = await this.encrypt(this.contacts);
        const encryptedGroups = await this.encrypt(this.groups);

        localStorage.setItem('p2p_history_enc', encryptedHistory);
        localStorage.setItem('p2p_contacts_enc', encryptedContacts);
        localStorage.setItem('p2p_groups_enc', encryptedGroups);

        if (!silent) this.broadcastSync();
    },

    async loadEncryptedData() {
        const cEnc = localStorage.getItem('p2p_contacts_enc');
        const hEnc = localStorage.getItem('p2p_history_enc');
        const gEnc = localStorage.getItem('p2p_groups_enc');

        // Helper to load with fallback
        const loadWithFallback = async (encKey, oldKey, target) => {
            let loaded = null;
            if (encKey) {
                loaded = await this.decrypt(encKey);
            }
            if (!loaded || Object.keys(loaded).length === 0) {
                const old = localStorage.getItem(oldKey);
                if (old) {
                    try {
                        loaded = JSON.parse(old);
                        console.log(`Restored ${target} from old storage`);
                    } catch (e) { }
                }
            }
            return loaded;
        };

        const contacts = await loadWithFallback(cEnc, 'p2p_contacts', 'contacts');
        if (contacts) this.contacts = contacts;

        const groups = await loadWithFallback(gEnc, 'p2p_groups', 'groups');
        if (groups) this.groups = groups;

        const history = await loadWithFallback(hEnc, 'p2p_history', 'history');
        if (history) this.history = history;

        // Load Session Keys
        await this.loadSessionSecrets();
    },

    saveContacts(silent = false) {
        this.saveMsgMigration(silent);
    },

    saveGroups(silent = false) {
        this.saveMsgMigration(silent);
    }
});

</script>
    <script>
// Authentication & Profile Logic (Restored)
Object.assign(App.prototype, {
    setSetupMode(mode) {
        document.getElementById('modeReg').classList.toggle('active', mode === 'reg');
        document.getElementById('modeLogin').classList.toggle('active', mode === 'login');

        if (mode === 'reg') {
            document.getElementById('setupTitle').innerText = "–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å";
            document.getElementById('setupDesc').innerText = "–í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è, —Ü–≤–µ—Ç –∏ –ø–∞—Ä–æ–ª—å";
            document.getElementById('setupColors').style.display = 'flex';
            document.getElementById('setupName').placeholder = "–ù–∏–∫–Ω–µ–π–º";
            document.getElementById('setupPass').placeholder = "–ü–∞—Ä–æ–ª—å";
            document.getElementById('login-2fa-choice').style.display = 'none';
            document.getElementById('setupSecretInput').style.display = 'none';
        } else {
            document.getElementById('setupTitle').innerText = "–í—Ö–æ–¥";
            document.getElementById('setupDesc').innerText = "–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞";
            document.getElementById('setupColors').style.display = 'none';
            document.getElementById('setupName').placeholder = "–í–∞—à –ù–∏–∫–Ω–µ–π–º";
            document.getElementById('setupPass').placeholder = "–í–∞—à –ü–∞—Ä–æ–ª—å";

            // Show 2FA choice if configured (logic simplified for restore)
            document.getElementById('login-2fa-choice').style.display = 'block';
        }
    },

    async register() {
        const name = document.getElementById('setupName').value.trim();
        const pass = document.getElementById('setupPass').value;

        if (!name || !pass) return this.showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è ‚ö†Ô∏è");

        // Basic unique ID generation
        const cleanName = name.toLowerCase().replace(/[^a-z0-9]/g, '');
        const uid = 'p2p_user_' + cleanName + '_' + Math.random().toString(36).substr(2, 4);

        // Color selection
        const activeColor = document.querySelector('.color-dot.active');
        const color = activeColor ? activeColor.getAttribute('data-color') : '#0084ff';

        // Save locally
        localStorage.setItem('p2p_nick', name);
        localStorage.setItem('p2p_uid', uid);
        localStorage.setItem('p2p_color', color);
        localStorage.setItem('p2p_pass', pass);

        // Generate Identity Key for E2EE
        await this.generateIdentityKey();

        this.showToast("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω! üöÄ");
        setTimeout(() => location.reload(), 500);
    },

    async login() {
        const name = document.getElementById('setupName').value.trim();
        const pass = document.getElementById('setupPass').value;

        const storedPass = localStorage.getItem('p2p_pass');
        const storedNick = localStorage.getItem('p2p_nick');

        if (storedPass && storedNick === name) {
            if (storedPass === pass) {
                location.reload();
            } else {
                this.showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚ùå");
            }
        } else {
            this.showToast("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ò–º–ø–æ—Ä—Ç/–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é.");
        }
    },

    finishSetup() {
        const isReg = document.getElementById('modeReg').classList.contains('active');
        if (isReg) {
            this.register();
        } else {
            this.login();
        }
    },

    checkHash() {
        const hash = window.location.hash.replace('#', '');
        if (!hash) return;

        const isLegacy = hash.startsWith('u_');
        const isNew = hash.startsWith('p2p_user_');

        if ((isLegacy || isNew) && hash !== this.myId) {
            if (!this.contacts[hash]) {
                if (this.addContact) {
                    this.addContact(hash, '–ó–∞–≥—Ä—É–∑–∫–∞...', '#555');
                }
            }
            if (this.selectChat) {
                this.selectChat(hash);
            }
            history.replaceState(null, null, ' ');
        }
    },

    updateMyProfileUI() {
        if (!this.myNick) {
            const nickEl = document.getElementById('myNickDisplay');
            if (nickEl) nickEl.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            return;
        }

        const nickEl = document.getElementById('myNickDisplay');
        if (nickEl) nickEl.innerText = this.myNick;

        const myIdEl = document.getElementById('myIdDisplay');
        if (myIdEl) {
            const isOnline = (this.peer && !this.peer.disconnected);
            const dot = isOnline
                ? '<span class="id-status-dot"></span>'
                : '<span class="id-status-dot" style="background:#555; box-shadow:none;"></span>';

            // Show ACTUAL Peer ID (full) for sharing
            const actualId = (this.peer && this.peer.id) ? this.peer.id : this.myId;
            myIdEl.innerHTML = `ID: ${actualId} ${dot}`;
        }

        // FIXED: Use correct ID myAvatarDisplay
        const avatarEl = document.getElementById('myAvatarDisplay');
        if (avatarEl) {
            avatarEl.innerText = this.myNick[0].toUpperCase();
            avatarEl.style.background = this.myColor;
        }

        // Update lock settings avatar too if exists
        const lockAvatar = document.getElementById('lockAvatar');
        if (lockAvatar) {
            lockAvatar.innerText = this.myNick[0].toUpperCase();
            lockAvatar.style.background = this.myColor;
            document.getElementById('lockNick').innerText = "–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, " + this.myNick;
        }

        // --- Update Telegram UI ---
        const tgToken = localStorage.getItem('p2p_tg_token');
        const tgChatId = localStorage.getItem('p2p_tg_chatid');
        const botInput = document.getElementById('tgBotToken');
        const chatInput = document.getElementById('tgChatId');

        if (botInput && tgToken) botInput.value = tgToken;
        if (chatInput && tgChatId) chatInput.value = tgChatId;

        const tgLabel = document.getElementById('tgStatusLabel');
        if (tgLabel) {
            if (tgToken && tgChatId) {
                tgLabel.innerText = "–ë–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω ‚úÖ";
                tgLabel.style.color = "var(--success)";
            } else {
                tgLabel.innerText = "–ë–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω";
                tgLabel.style.color = "var(--text-dim)";
            }
        }

        const tgEnabledSwitch = document.getElementById('settingTgEnabled');
        if (tgEnabledSwitch) {
            tgEnabledSwitch.checked = this.notificationsEnabled;
            const settingsDiv = document.getElementById('tgSettings');
            if (settingsDiv) settingsDiv.style.display = this.notificationsEnabled ? 'block' : 'none';
        }
    },

    // Auth Helpers
    unlock() {
        const pass = document.getElementById('lockPass').value;
        if (pass === this.myPass) {
            document.getElementById('lock-overlay').style.display = 'none';
            localStorage.removeItem('p2p_is_locked');
            if (!this.peer) {
                this.start();
                this.checkIP();
            }
        } else {
            document.getElementById('lockError').innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
        }
    },

    clearData() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–µ—Å—å —á–∞—Ç –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ!")) {
            localStorage.clear();
            location.reload();
        }
    },

    copyMyId() {
        const fullId = (this.peer && this.peer.id) ? this.peer.id : this.myId;
        if (fullId) {
            navigator.clipboard.writeText(fullId);
            this.showToast("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! üìã");
        }
    },

    updateProfile() {
        const nick = document.getElementById('editName').value;
        const pass = document.getElementById('editPass').value;
        if (nick) {
            this.myNick = nick; // Use 'this' as it is bound to app instance
            localStorage.setItem('p2p_nick', nick);
        }
        if (pass) {
            this.myPass = pass;
            localStorage.setItem('p2p_pass', pass);
        }
        this.updateMyProfileUI();
        this.showToast("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω");
        document.getElementById('settings-overlay').style.display = 'none';
    },

    logout(force = false) {
        if (force || confirm("–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è? (–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)")) {
            localStorage.setItem('p2p_is_locked', 'true');
            location.reload();
        }
    },

    async checkIP() {
        if (!this.ipCheckEnabled) return;

        try {
            const res = await fetch('https://api.ipify.org?format=json');
            const data = await res.json();
            const currentIp = data.ip;
            const lastIp = localStorage.getItem('p2p_last_ip');

            if (lastIp && lastIp !== currentIp) {
                // IP Changed!
                this.showToast(`‚ö†Ô∏è IP –∏–∑–º–µ–Ω–∏–ª—Å—è: ${lastIp} -> ${currentIp}`);
                // Lock the app for security
                localStorage.setItem('p2p_is_locked', 'true');
                localStorage.setItem('p2p_last_ip', currentIp); // Update known IP
                setTimeout(() => location.reload(), 2000);
            } else {
                localStorage.setItem('p2p_last_ip', currentIp);
            }
        } catch (e) {
            console.warn("IP Check failed:", e);
        }
    },

    // Generate Identity Key Helper
    async generateIdentityKey() {
        const keyPair = await window.crypto.subtle.generateKey(
            { name: "ECDH", namedCurve: "P-256" },
            true,
            ["deriveKey", "deriveBits"]
        );
        this.identityKeyPair = keyPair;

        const exportedPriv = await window.crypto.subtle.exportKey("jwk", keyPair.privateKey);
        const exportedPub = await window.crypto.subtle.exportKey("jwk", keyPair.publicKey);

        localStorage.setItem('p2p_priv_key', JSON.stringify(exportedPriv));
        localStorage.setItem('p2p_pub_key', JSON.stringify(exportedPub));
    },

    // Security & Settings
    toggleIncognito(checked) {
        this.incognitoMode = checked;
        localStorage.setItem('p2p_incognito', checked);
        this.showToast(checked ? "üïµÔ∏è –†–µ–∂–∏–º –ò–Ω–∫–æ–≥–Ω–∏—Ç–æ –í–ö–õ" : "üïµÔ∏è –†–µ–∂–∏–º –ò–Ω–∫–æ–≥–Ω–∏—Ç–æ –í–´–ö–õ");
    },

    setBurnTimer(seconds) {
        this.burnTimer = parseInt(seconds);
        localStorage.setItem('p2p_burn_timer', seconds);
        if (seconds > 0) {
            this.showToast(`üî• –°–æ–æ–±—â–µ–Ω–∏—è –∏—Å—á–µ–∑–Ω—É—Ç —á–µ—Ä–µ–∑ ${seconds} —Å–µ–∫`);
        } else {
            this.showToast("üî• –¢–∞–π–º–µ—Ä —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω");
        }
    },

    toggleTg(checked) {
        if (checked) {
            if (Notification.permission === 'granted') {
                this.notificationsEnabled = true;
                this.showToast("üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã");
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        this.notificationsEnabled = true;
                        this.showToast("üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã");
                    } else {
                        this.notificationsEnabled = false;
                        document.getElementById('settingTgEnabled').checked = false;
                        this.showToast("‚ùå –î–æ—Å—Ç—É–ø –∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º –∑–∞–ø—Ä–µ—â–µ–Ω");
                    }
                    localStorage.setItem('p2p_notifications', this.notificationsEnabled);
                });
                return; // Check logic async
            } else {
                this.notificationsEnabled = false;
                document.getElementById('settingTgEnabled').checked = false;
                this.showToast("‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ");
            }
        } else {
            this.notificationsEnabled = false;
            this.showToast("üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã");
        }
        localStorage.setItem('p2p_notifications', this.notificationsEnabled);
    },

    toggleIpCheck(checked) {
        localStorage.setItem('p2p_ip_check', checked);
        this.showToast(checked ? "üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –≤–∫–ª—é—á–µ–Ω–∞" : "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –æ—Ç–∫–ª—é—á–µ–Ω–∞");
    },

    // --- Telegram Bot Integration (Direct API) ---
    saveTgSettings() {
        const token = document.getElementById('tgBotToken').value.trim();
        const chatId = document.getElementById('tgChatId').value.trim();
        if (token) localStorage.setItem('p2p_tg_token', token);
        if (chatId) localStorage.setItem('p2p_tg_chatid', chatId);
        this.showToast("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        if (this.tgEnabled) this.initTgBot();
    },

    async testTgConnection() {
        const token = document.getElementById('tgBotToken').value.trim() || localStorage.getItem('p2p_tg_token');
        const chatId = document.getElementById('tgChatId').value.trim() || localStorage.getItem('p2p_tg_chatid');

        if (!token || !chatId) return this.showToast("–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ Token –∏ Chat ID ‚ö†Ô∏è");

        const label = document.getElementById('tgStatusLabel');
        label.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
        label.style.color = "var(--text-dim)";

        try {
            const res = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: `‚úÖ –°–≤—è–∑—å —Å P2P Messenger —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!\nüë§ –ù–∏–∫: ${this.myNick}\nüåê IP: Checking...`
                })
            });
            const data = await res.json();
            if (data.ok) {
                this.showToast("–ë–æ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram üì®");
                label.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚úÖ";
                label.style.color = "var(--success)";
            } else {
                throw new Error(data.description);
            }
        } catch (e) {
            console.error(e);
            this.showToast("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚ùå");
            label.innerText = "–û—à–∏–±–∫–∞: " + e.message;
            label.style.color = "var(--danger)";
        }
    },

    async sendTgMessage(text) {
        const token = localStorage.getItem('p2p_tg_token') || "8508148034:AAFJRU766RAY1Rt6-XfYB6_PbEpZ7WwgND4";
        const chatId = localStorage.getItem('p2p_tg_chatid');
        if (!this.tgEnabled || !token || !chatId) return;

        try {
            await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: chatId, text: text, parse_mode: 'HTML' })
            });
        } catch (e) {
            console.warn("Failed to send TG message:", e);
        }
    },

    async pollTgUpdates() {
        if (!this.tgEnabled) return;
        const token = localStorage.getItem('p2p_tg_token') || "8508148034:AAFJRU766RAY1Rt6-XfYB6_PbEpZ7WwgND4";
        const chatId = localStorage.getItem('p2p_tg_chatid');
        if (!token || !chatId) return;

        const lastOffset = localStorage.getItem('p2p_tg_offset') || 0;

        try {
            const res = await fetch(`https://api.telegram.org/bot${token}/getUpdates?offset=${lastOffset}&timeout=30`);
            const data = await res.json();
            if (data.ok && data.result.length > 0) {
                for (const update of data.result) {
                    const msg = update.message;
                    if (msg && msg.chat.id.toString() === chatId.toString() && msg.text) {
                        this.handleTgCommand(msg.text);
                    }
                    localStorage.setItem('p2p_tg_offset', update.update_id + 1);
                }
            }
        } catch (e) {
            console.warn("TG Polling error:", e);
        }

        // Loop polling
        setTimeout(() => this.pollTgUpdates(), 3000);
    },

    handleTgCommand(cmd) {
        const command = cmd.toLowerCase().trim();
        if (command === '/status') {
            const status = `üìä <b>–°—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏:</b>\nüë§ –ù–∏–∫: ${this.myNick}\nüåê –°–µ—Ç—å: ${this.peer && !this.peer.disconnected ? 'Active' : 'Offline'}\nüÜî ID: <code>${this.myId}</code>`;
            this.sendTgMessage(status);
        } else if (command === '/logout' || command === '/kick') {
            this.sendTgMessage(`üö´ –°–µ—Å—Å–∏—è –¥–ª—è <b>${this.myNick}</b> –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ.`);
            this.logout(true);
        } else if (command === '/login' || command === '/2fa') {
            const code = Math.floor(100000 + Math.random() * 900000);
            this.sendTgMessage(`üîê –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: <b>${code}</b>\nüõ°Ô∏è –í–∞—à –°–µ–∫—Ä–µ—Ç: <code>${this.mySecret}</code>`);
        } else if (command === '/help' || command === '‚ùì –ø–æ–º–æ—â—å') {
            this.sendTgMessage(`ü§ñ <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n/status - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n/logout - –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é\n/login - –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏ —Å–µ–∫—Ä–µ—Ç\n/kick - —Ç–æ –∂–µ —Å–∞–º–æ–µ —á—Ç–æ logout`);
        }
    },

    initTgBot() {
        const token = localStorage.getItem('p2p_tg_token') || "8508148034:AAFJRU766RAY1Rt6-XfYB6_PbEpZ7WwgND4";
        const chatId = localStorage.getItem('p2p_tg_chatid');
        const enabled = localStorage.getItem('p2p_notifications') === 'true';

        this.tgEnabled = enabled;
        if (enabled && token && chatId) {
            this.pollTgUpdates();
            this.sendTgMessage(`üöÄ <b>–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω</b>\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.`);
        }
    },

    // Legacy/Sync methods updated for Direct API
    startTgPairing() {
        alert("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É: –≤—Å—Ç–∞–≤—å—Ç–µ Token –æ—Ç @BotFather –∏ –≤–∞—à Chat ID –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.");
    },
    unlinkTg() {
        localStorage.removeItem('p2p_tg_token');
        localStorage.removeItem('p2p_tg_chatid');
        localStorage.setItem('p2p_notifications', 'false');
        location.reload();
    },

    promptInstall() {
        // Simple prompt logic usually involves capturing the install event
        this.showToast("–§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
    },
    exportData() {
        // Full export for domain migration
        const data = {
            nick: this.myNick,
            uid: this.myId,
            color: this.myColor,
            pass: this.myPass,
            secret: this.mySecret,
            contacts: this.contacts,
            groups: this.groups,
            history: this.history,
            myDevices: this.myDevices,
            deviceSuffix: this.deviceSuffix,
            connSettings: this.connSettings,
            privKey: localStorage.getItem('p2p_priv_key'),
            pubKey: localStorage.getItem('p2p_pub_key'),
            incognito: localStorage.getItem('p2p_incognito'),
            burnTimer: localStorage.getItem('p2p_burn_timer'),
            notifications: localStorage.getItem('p2p_notifications'),
            ipCheck: localStorage.getItem('p2p_ip_check'),
            deviceSuffix: localStorage.getItem('p2p_device_suffix')
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `messenger_backup_${this.myNick}_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        this.showToast("–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω! üíæ");
    },

    handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.uid || !data.nick) {
                    throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞");
                }
                if (confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å "${data.nick}"? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.`)) {
                    this.applyImportedProfile(data);
                }
            } catch (err) {
                console.error(err);
                this.showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ ‚ùå");
            }
        };
        reader.readAsText(file);
    }
});

</script>
    <script>
// Synchronization & P2P Logic (Restored)
Object.assign(App.prototype, {
    // 1. Discover my other trusted devices
    discoverMyDevices() {
        if (!this.myDevices || this.myDevices.length === 0) return;
        this.myDevices.forEach(peerId => {
            if (peerId !== this.peer.id) {
                const conn = this.peer.connect(peerId);
                conn.on('open', () => {
                    this.connections[peerId] = conn;
                    console.log('Connected to trusted device:', peerId);
                    // Share current state
                    this.broadcastSync();
                });
            }
        });
    },

    // 2. Add Trusted Device
    addTrustedDevice(peerId) {
        if (!this.myDevices.includes(peerId) && peerId !== this.peer.id) {
            this.myDevices.push(peerId);
            localStorage.setItem('p2p_my_devices', JSON.stringify(this.myDevices));
            console.log('Device trusted:', peerId);
            this.showToast("–ù–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ üõ°Ô∏è");
        }
    },

    // 3. Start Sync Pull
    async startSyncPull() {
        const partialId = document.getElementById('syncInputCode').value.trim().toLowerCase();
        if (!partialId) return this.showToast("–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ –∫–æ–¥");

        document.getElementById('syncTargetStatus').innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É...";
        console.log('Syncing with:', partialId);

        let targetId = partialId;
        if (!targetId.includes('_dev_') && !targetId.startsWith('p2p_user_') && !targetId.startsWith('u_')) {
            targetId = this.normalizeId(targetId);
        }

        // Timeout for connection
        const timeout = setTimeout(() => {
            document.getElementById('syncTargetStatus').innerText = "–ó–∞–ø—Ä–æ—Å –∑–∞—Ç—è–Ω—É–ª—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.";
        }, 12000);

        // Use temp peer if this.peer is null (pre-login sync)
        let activePeer = this.peer;
        if (!activePeer) {
            this.logSync("–°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...");
            activePeer = await this.initTempPeerForSync();
            if (!activePeer) {
                clearTimeout(timeout);
                return this.showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ ‚ö†Ô∏è");
            }
        }

        if (targetId === this.myId || targetId === activePeer.id) {
            return this.showToast("–ù–µ–ª—å–∑—è —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å —Å–∞–º–∏–º —Å–æ–±–æ–π ‚ö†Ô∏è");
        }

        // Standard connection with explicit JSON serialization
        this.logSync("Connecting to: " + targetId);
        const conn = activePeer.connect(targetId, { serialization: 'json' });

        conn.on('open', () => {
            clearTimeout(timeout);
            this.logSync("Connection OPEN! Sending handshake...");
            document.getElementById('syncTargetStatus').innerText = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...";
            conn.send({ type: 'sync_pull' });
        });

        conn.on('data', (data) => {
            this.logSync("Data received: " + data.type);
            if (data.type === 'sync_push') {
                document.getElementById('syncTargetStatus').innerText = "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...";
                // If using temp peer (pre-login), apply as new profile
                if (this.tempPeer) {
                    this.applyImportedProfile(data.payload);
                } else {
                    this.processSyncData(data.payload);
                }
            }
        });

        conn.on('error', (err) => {
            clearTimeout(timeout);
            console.error('Sync Connect Error:', err);
            this.logSync("Error: " + err.type);
            document.getElementById('syncTargetStatus').innerText = "–û—à–∏–±–∫–∞: " + err.type;
        });

        conn.on('close', () => {
            // Cleanup if needed
        });
    },

    // 4. Process Sync Data
    async processSyncData(data) {
        if (!data) return;
        this.contacts = data.contacts || {};
        this.history = data.history || {};
        this.groups = data.groups || {};

        // Save imported data
        this.saveContacts(true);
        this.saveGroups(true);
        this.saveMsgMigration(true);
        this.refreshContacts();

        this.showToast("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! ‚úÖ");
        setTimeout(() => location.reload(), 1000);
    },

    // 5. Broadcast Sync Update
    async broadcastSync() {
        if (!this.myDevices.length) return;
        const payload = {
            type: 'auto_sync',
            contacts: this.contacts,
            groups: this.groups,
            history: this.history
        };

        Object.keys(this.connections).forEach(id => {
            if (this.myDevices.includes(id)) {
                this.connections[id].send(payload);
            }
        });
    },

    relayToMyDevices(payload) {
        Object.keys(this.connections).forEach(id => {
            if (this.myDevices.includes(id)) {
                this.connections[id].send(payload);
            }
        });
    },

    showSyncOverlay(mode) {
        document.getElementById('sync-overlay').style.display = 'flex';
        const sourceView = document.getElementById('syncSourceView');
        const targetView = document.getElementById('syncTargetView');

        if (mode === 'source') {
            sourceView.style.display = 'block';
            targetView.style.display = 'none';
            // Show the FULL Peer ID for guaranteed connectivity
            const syncId = (this.peer && this.peer.id) ? this.peer.id : this.myId;
            document.getElementById('syncCodeDisplay').innerText = syncId;
            document.getElementById('syncSourceStatus').innerText = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...";
        } else {
            sourceView.style.display = 'none';
            targetView.style.display = 'block';
            document.getElementById('syncInputCode').value = '';
            document.getElementById('syncTargetStatus').innerText = "";
        }
    },

    async handleSyncPush(conn) {
        this.addTrustedDevice(conn.peer); // Bidirectional trust
        document.getElementById('syncSourceStatus').innerText = "–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö...";

        const data = {
            nick: this.myNick,
            uid: this.myId,
            color: this.myColor,
            pass: this.myPass, // Hashed pass if relying on it
            secret: this.mySecret,
            contacts: this.contacts,
            history: this.history,
            groups: this.groups,
            privKey: localStorage.getItem('p2p_priv_key'), // Send Keys so other device can decrypt!
            pubKey: localStorage.getItem('p2p_pub_key'),
            tgBound: !!this.isTgBound // Example flag
        };

        conn.send({ type: 'sync_push', payload: data });

        setTimeout(() => {
            document.getElementById('sync-overlay').style.display = 'none';
            this.showToast("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! ‚úÖ");
        }, 1000);
    },

    // --- Pre-Login Sync Functions ---

    startPreLoginSync() {
        document.getElementById('setup-overlay').style.display = 'none';
        document.getElementById('sync-overlay').style.display = 'flex';
        document.getElementById('syncSourceView').style.display = 'none';
        document.getElementById('syncTargetView').style.display = 'block';
        document.getElementById('syncInputCode').value = '';
        document.getElementById('syncTargetStatus').innerText = "–í–≤–µ–¥–∏—Ç–µ Source ID —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞";
    },

    importData() {
        this.startPreLoginSync();
    },

    async initTempPeerForSync() {
        return new Promise((resolve) => {
            const tempId = 'sync_temp_' + Math.random().toString(36).substr(2, 8);
            console.log('[PreLoginSync] Creating temp peer:', tempId);

            const peer = new Peer(tempId, {
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                },
                debug: 1
            });

            peer.on('open', () => {
                console.log('[PreLoginSync] Temp peer ready:', tempId);
                this.tempPeer = peer;
                resolve(peer);
            });

            peer.on('error', (err) => {
                console.error('[PreLoginSync] Temp peer error:', err);
                this.logSync("–û—à–∏–±–∫–∞: " + err.type);
                resolve(null);
            });

            setTimeout(() => {
                if (!peer.open) {
                    console.error('[PreLoginSync] Temp peer timeout');
                    peer.destroy();
                    resolve(null);
                }
            }, 10000);
        });
    },

    applyImportedProfile(data) {
        console.log('[PreLoginSync] Applying imported profile:', data.nick);

        if (data.nick) localStorage.setItem('p2p_nick', data.nick);
        if (data.uid) localStorage.setItem('p2p_uid', data.uid);
        if (data.color) localStorage.setItem('p2p_color', data.color);
        if (data.pass) localStorage.setItem('p2p_pass', data.pass);
        if (data.secret) localStorage.setItem('p2p_secret', data.secret);
        if (data.contacts) localStorage.setItem('p2p_contacts', JSON.stringify(data.contacts));
        if (data.history) localStorage.setItem('p2p_history', JSON.stringify(data.history));
        if (data.groups) localStorage.setItem('p2p_groups', JSON.stringify(data.groups));

        if (data.privKey) localStorage.setItem('p2p_priv_key', data.privKey);
        if (data.pubKey) localStorage.setItem('p2p_pub_key', data.pubKey);

        // Also save encrypted versions if provided
        // But usually we just reload and let app encrypt on next save? 
        // For robustness, save what we got.

        if (this.tempPeer) {
            this.tempPeer.destroy();
            this.tempPeer = null;
        }

        this.showToast("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...");
        setTimeout(() => location.reload(), 1500);
    }
});

</script>
    <script>
// UI & Rendering Logic
Object.assign(App.prototype, {
    // 1. Refresh Contacts List
    refreshContacts() {
        const list = document.getElementById('contactList');
        if (!list) return;
        list.innerHTML = '';

        // Add Groups first
        Object.values(this.groups).forEach(group => {
            const div = document.createElement('div');
            div.className = `contact-item ${this.activeChatId === group.id ? 'active' : ''}`;
            div.onclick = () => this.selectChat(group.id);
            div.innerHTML = `
                <div class="avatar" style="background:#555">üë•</div>
                <div class="contact-info">
                    <div class="name">${this.escapeHtml(group.name)} <span style="font-size:10px; opacity:0.6;">(–ì—Ä—É–ø–ø–∞)</span></div>
                    <div class="last-msg">${this.escapeHtml(group.last || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π')}</div>
                </div>
            `;
            list.appendChild(div);
        });

        // Add Contacts
        Object.keys(this.contacts).forEach(id => {
            const contact = this.contacts[id];
            const isOnline = this.connections[id] && this.connections[id].open;

            const div = document.createElement('div');
            div.className = `contact-item ${this.activeChatId === id ? 'active' : ''}`;
            div.onclick = () => this.selectChat(id);
            div.innerHTML = `
                <div class="avatar" style="background:${contact.color}">${contact.name[0].toUpperCase()}</div>
                <div class="contact-info">
                    <div class="name">
                        ${this.escapeHtml(contact.name)} 
                        ${isOnline ? '<span style="color:var(--accent); font-size:10px;">‚óè</span>' : ''}
                    </div>
                    <div class="last-msg">${this.escapeHtml(contact.last || '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç')}</div>
                </div>
            `;
            list.appendChild(div);
        });
    },

    // 2. Select Chat
    selectChat(id) {
        this.activeChatId = id;

        // Desktop: toggle empty state / chat
        const empty = document.getElementById('emptyChat');
        const chat = document.getElementById('chatArea');
        if (empty) empty.style.display = 'none';
        if (chat) chat.style.display = 'flex';

        // Mobile: Hide sidebar, show chat
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar').style.display = 'none';
            if (chat) chat.style.display = 'flex'; // Ensure flex
            // Also enable back button in header (it's already there)
        }

        this.updateChatHeader();
        this.renderHistory(id);
        this.refreshContacts();

        // Enable and Focus input
        const input = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        if (input) {
            input.disabled = false;
            input.focus();
        }
        if (sendBtn) {
            sendBtn.disabled = false;
        }
    },

    // Mobile Back Button / Sidebar Toggle
    toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const chatArea = document.getElementById('chatArea');
        const backdrop = document.getElementById('sidebar-backdrop');

        if (window.innerWidth <= 768) {
            // Mobile: If chat is open, "Back" hides chat and shows sidebar
            if (chatArea && chatArea.style.display !== 'none') {
                chatArea.style.display = 'none';
                sidebar.style.display = 'flex';
                this.activeChatId = null;
                return;
            }
        }

        // General: Toggle active class
        if (sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
            if (backdrop) backdrop.style.display = 'none';
        } else {
            sidebar.classList.add('active');
            if (backdrop) backdrop.style.display = 'block';
        }
    },

    // 3. Update Chat Header
    updateChatHeader() {
        const headerName = document.getElementById('chatName');
        const headerStatus = document.getElementById('chatStatus');
        const headerAvatar = document.getElementById('chatAvatar');
        const id = this.activeChatId;

        if (this.groups[id]) {
            headerName.innerText = this.groups[id].name;
            headerStatus.innerText = `${this.groups[id].members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
            return;
        }

        const contact = this.contacts[id];
        if (contact) {
            headerName.innerText = contact.name || id;
            if (headerAvatar) {
                headerAvatar.innerText = (contact.name || id)[0].toUpperCase();
                headerAvatar.style.background = contact.color || 'var(--accent)';
            }
            const isOnline = this.connections[id] && this.connections[id].open;

            if (isOnline) {
                if (this.sessionSecrets[id]) {
                    headerStatus.innerHTML = '<span style="color:var(--success)">üîí E2EE ¬∑ –û–Ω–ª–∞–π–Ω</span>';
                } else {
                    headerStatus.innerText = '–û–Ω–ª–∞–π–Ω (–û–±–º–µ–Ω –∫–ª—é—á–∞–º–∏...)';
                }
            } else {
                headerStatus.innerText = '–û—Ñ—Ñ–ª–∞–π–Ω';
            }
        } else {
            headerName.innerText = id; // Fallback
            headerStatus.innerText = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
        }
    },

    // 4. Render History
    renderHistory(chatId) {
        const container = document.getElementById('messages');
        container.innerHTML = '';

        const messages = this.history[chatId] || [];

        messages.forEach(msg => {
            const div = document.createElement('div');
            div.className = `message ${msg.side}`;

            // For groups, show sender name
            let senderName = '';
            if (this.groups[chatId] && msg.side === 'them' && msg.senderId) {
                const sender = this.contacts[msg.senderId];
                senderName = `<div style="font-size:10px; opacity:0.7; margin-bottom:2px;">${sender ? sender.name : '–£—á–∞—Å—Ç–Ω–∏–∫'}</div>`;
            }

            div.innerHTML = `
                ${senderName}
                <div class="text">${this.escapeHtml(msg.text)}</div>
                <div class="time">${this.formatDate(msg.timestamp)}</div>
            `;
            container.appendChild(div);
        });

        container.scrollTop = container.scrollHeight;
    },

    // 5. Open Settings (UI)
    openSettings() {
        const overlay = document.getElementById('settings-overlay');
        const modal = overlay.querySelector('.modal');
        overlay.style.display = 'flex';
        if (modal) modal.scrollTop = 0;
        this.updateEncryptionStatus();

        // Sync UI with State
        const nameInput = document.getElementById('editName');
        if (nameInput) nameInput.value = this.myNick || '';

        const incognitoCheck = document.getElementById('settingIncognito');
        if (incognitoCheck) incognitoCheck.checked = this.incognitoMode;

        const burnSelect = document.getElementById('settingBurn');
        if (burnSelect) burnSelect.value = this.burnTimer;

        const notifCheck = document.getElementById('settingTgEnabled');
        if (notifCheck) notifCheck.checked = this.notificationsEnabled;

        const ipCheck = document.getElementById('settingIpCheck');
        if (ipCheck) ipCheck.checked = this.ipCheckEnabled;

        // Connectivity Sync
        const hostIn = document.getElementById('connHost');
        if (hostIn) hostIn.value = this.connSettings.host || '';
        const portIn = document.getElementById('connPort');
        if (portIn) portIn.value = this.connSettings.port || '';
        const pathIn = document.getElementById('connPath');
        if (pathIn) pathIn.value = this.connSettings.path || '/';
        const secureIn = document.getElementById('connSecure');
        if (secureIn) secureIn.checked = this.connSettings.secure;
        const iceIn = document.getElementById('connIce');
        if (iceIn) {
            iceIn.value = this.connSettings.ice || '';
            iceIn.placeholder = '[{"urls":"stun:stun.l.google.com:19302"}, ...]';
        }
    },

    updateEncryptionStatus() {
        const status = document.getElementById('encryptionStatus');
        if (status) {
            status.innerHTML = this.myPass ? 'üõ°Ô∏è –î–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã (AES-GCM)' : '‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–æ–ª—å)';
            status.style.color = this.myPass ? 'var(--success)' : 'var(--danger)';
        }
    },



    // --- Contact & Group Management ---

    addContact(id, name, color) {
        if (!id) return;
        if (id === this.myId) return this.showToast("–≠—Ç–æ –≤–∞—à ID ü§∑‚Äç‚ôÇÔ∏è");
        if (this.contacts[id]) return this.selectChat(id);

        this.contacts[id] = {
            id: id,
            name: name || id,
            color: color || this.getRandomColor(),
            added: Date.now(),
            last: ''
        };
        this.saveContacts();
        this.refreshContacts();
        this.showToast("–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω! üë§");

        // Try to connect
        if (!this.connections[id]) {
            const conn = this.peer.connect(id, { serialization: 'json' });
            this.handleConnection(conn);
        }
    },

    // Create Group Logic
    createGroup() {
        const name = document.getElementById('groupNameInput').value.trim();
        if (!name) return this.showToast("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã");

        const gid = 'group_' + Math.random().toString(36).substr(2, 9);
        const color = this.getRandomColor();

        this.groups[gid] = {
            id: gid,
            name: name,
            members: [this.myId], // Start with self
            isActive: true,
            currKey: null, // For E2EE (todo)
            color: color,
            creator: this.myId,
            created: Date.now(),
            last: '–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞'
        };
        this.saveGroups();
        this.refreshContacts();
        this.selectChat(gid);
        this.showToast(`–ì—Ä—É–ø–ø–∞ "${name}" —Å–æ–∑–¥–∞–Ω–∞! üë•`);

        const overlay = document.getElementById('group-create-overlay');
        if (overlay) overlay.style.display = 'none';
        const input = document.getElementById('groupNameInput');
        if (input) input.value = '';
    },

    leaveGroup(gid) {
        if (confirm("–í—ã–π—Ç–∏ –∏–∑ –≥—Ä—É–ø–ø—ã?")) {
            delete this.groups[gid];
            this.saveGroups();
            this.activeChatId = null;
            document.getElementById('emptyChat').style.display = 'flex';
            document.getElementById('chatArea').style.display = 'none';
            this.refreshContacts();
        }
    },

    // UI Event Handlers
    shareInvite() {
        const fullId = (this.peer && this.peer.id) ? this.peer.id : this.myId;
        const url = `${window.location.origin}${window.location.pathname}#${fullId}`;
        if (navigator.share) {
            navigator.share({
                title: '–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä P2P',
                text: '–î–∞–≤–∞–π –æ–±—â–∞—Ç—å—Å—è –≤ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º P2P –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ!',
                url: url
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(url).then(() => this.showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! üîó'));
        }
    },

    tryAddFriend() {
        const input = document.getElementById('contactSearch');
        const val = input.value.trim();
        if (!val) return;

        // Remove spaces
        const id = val.replace(/\s/g, '');

        if (id === this.myId) return this.showToast("–≠—Ç–æ –≤–∞—à ID");

        // Proactive Hint: If ID is short, warn user
        if (!id.includes('_dev_')) {
            this.showToast("‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ, ID –Ω–µ–ø–æ–ª–Ω—ã–π. –î—Ä—É–≥ –¥–æ–ª–∂–µ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –í–ï–°–¨ ID –∏–∑ —Å–∞–π–¥–±–∞—Ä–∞!");
        }

        if (this.contacts[id]) {
            this.selectChat(id);
            input.value = '';
        } else {
            this.addContact(id);
            input.value = '';
        }
    },

    toggleMembersList() {
        const sidebar = document.getElementById('membersSidebar');
        if (!sidebar) return;

        if (sidebar.style.display === 'none') {
            sidebar.style.display = 'block';
            this.renderMembersList();
        } else {
            sidebar.style.display = 'none';
        }
    },

    renderMembersList() {
        const list = document.getElementById('membersList');
        const gid = this.activeChatId;
        if (!list || !this.groups[gid]) return;

        list.innerHTML = '';
        this.groups[gid].members.forEach(mid => {
            const div = document.createElement('div');
            div.className = 'member-item';
            div.style.padding = '5px';
            div.style.borderBottom = '1px solid var(--border)';

            const contact = this.contacts[mid];
            const name = contact ? contact.name : mid;
            const isMe = mid === this.myId;

            div.innerHTML = `
                <div style="font-size:12px;">${isMe ? '–í—ã' : this.escapeHtml(name)}</div>
                <div style="font-size:10px; color:var(--text-dim);">${mid}</div>
            `;
            list.appendChild(div);
        });
    },

    showSafetyInfo() {
        document.getElementById('safety-overlay').style.display = 'flex';
        // Calculate fingerprint if possible
        // Placeholder
        document.getElementById('safetyFingerprintDisplay').innerText = "ECDH-P256-AES-GCM";
    }
});

</script>

    <!-- Hidden File Input for Migration -->
    <input type="file" id="importFile" style="display:none" onchange="app.handleImportFile(event)" accept=".json">

    <!-- Init -->
    <script>
        // Initialize App instance after all modules are loaded
        window.app = new App();

        // Load event
        window.addEventListener('load', () => {
            app.init();
        });

        // Service Worker only works over HTTP, skip for Electron (file://)
        if ('serviceWorker' in navigator && location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Failed', err));
            });
        }
    </script>
</body>

</html>